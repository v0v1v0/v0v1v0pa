<div class="container">

<table style="width: 100%;"><tr>
<td>multi_trial</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Simulate and analyse multiple trials</h2>

<h3>Description</h3>

<p>Multiple trials and simulated and analysed up to the final
analysis stage, irrespective of whether it would have been stopped for
early success or expected futility. The output of the trials is handled
elsewhere.
</p>


<h3>Usage</h3>

<pre><code class="language-R">multi_trial(
  sens_true,
  spec_true,
  prev_true,
  endpoint = "both",
  sens_pg = 0.8,
  spec_pg = 0.8,
  prior_sens = c(0.1, 0.1),
  prior_spec = c(0.1, 0.1),
  prior_prev = c(0.1, 0.1),
  succ_sens = 0.95,
  succ_spec = 0.95,
  n_at_looks,
  n_mc = 10000,
  n_trials = 1000,
  ncores
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>sens_true</code></td>
<td>
<p>scalar. True assumed sensitivity (must be between 0 and 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>spec_true</code></td>
<td>
<p>scalar. True assumed specificity (must be between 0 and 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prev_true</code></td>
<td>
<p>scalar. True assumed prevalence as measured by the
gold-standard reference test (must be between 0 and 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>endpoint</code></td>
<td>
<p>character. The endpoint(s) that must meet a performance goal
criterion. The default is <code>code = "both"</code>, which means that the
endpoint is based simultaneously on sensitivity and specificity.
Alternative options are to specify <code>code = "sens"</code> or <code>code =
"spec"</code> for sensitivity and specificity, respectively. If only a single
endpoint is selected (e.g. sensitivity), then the PG and success
probability threshold of the other statistic are set to 1, and ignored for
later analysis.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sens_pg</code></td>
<td>
<p>scalar. Performance goal (PG) for the sensitivity endpoint,
such that the the posterior probability that the PG is exceeded is
calculated. Must be between 0 and 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>spec_pg</code></td>
<td>
<p>scalar. Performance goal (PG) for the specificity endpoint,
such that the the posterior probability that the PG is exceeded is
calculated. Must be between 0 and 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prior_sens</code></td>
<td>
<p>vector. A vector of length 2 with the prior shape
parameters for the sensitivity Beta distribution.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prior_spec</code></td>
<td>
<p>vector. A vector of length 2 with the prior shape
parameters for the specificity Beta distribution.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prior_prev</code></td>
<td>
<p>vector. A vector of length 2 with the prior shape
parameters for the prevalence Beta distribution.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>succ_sens</code></td>
<td>
<p>scalar. Probability threshold for the sensitivity to exceed
in order to declare a success. Must be between 0 and 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>succ_spec</code></td>
<td>
<p>scalar. Probability threshold for the specificity to exceed
in order to declare a success. Must be between 0 and 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n_at_looks</code></td>
<td>
<p>vector. Sample sizes for each interim look. The final value
(or only value if no interim looks are planned) is the maximum allowable
sample size for the trial.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n_mc</code></td>
<td>
<p>integer. Number of Monte Carlo draws to use for sampling from the
Beta-Binomial distribution.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n_trials</code></td>
<td>
<p>integer. The number of clinical trials to simulate overall,
which will be used to evaluate the operating characteristics.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ncores</code></td>
<td>
<p>integer. The number of cores to use for parallel processing. If
'ncores' is missing, it defaults to the maximum number of cores available
(spare 1).</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function simulates multiple trials and analyses each stage of the trial
(i.e. at each interim analysis sample size look) irrespective of whether a
stopping rule was triggered or not. The operating characteristics are handled
by a separate function, which accounts for the stopping rules and any other
trial constraints. By enumerating each stage of the trial, additional
insights can be gained such as: for a trial that stopped early for futility,
what is the probability that it would eventually go on to be successful if
the trial had not stopped. The details on how each trial are simulated here
are described below.
</p>
<p><strong>Simulating a single trial</strong>
</p>
<p>Given true values for the test sensitivity (<code>sens_true</code>), specificity
(<code>spec_true</code>), and the prevalence (<code>prev_true</code>) of disease, along
with a sample size look strategy (<code>n_at_looks</code>), it is straightforward
to simulate a complete dataset using the binomial distribution. That is, a
data frame with true disease status (reference test), and the new diagnostic
test result.
</p>
<p><strong>Posterior probability of exceeding PG at current look</strong>
</p>
<p>At a given sample size look, the posterior probability of an endpoint (e.g.
sensitivity) exceeding the pre-specified PG (<code>sens_pg</code>) can be
calculated as follows.
</p>
<p>If we let <code class="reqn">\theta</code> be the test property of interest (e.g. sensitivity),
and if we assume a prior distribution of the form
</p>
<p style="text-align: center;"><code class="reqn">\theta ~ Beta(\alpha, \beta),</code>
</p>

<p>then with <code class="reqn">X | \theta \sim Bin(n, \theta)</code>, where <code class="reqn">X</code> is the number
of new test positive cases from the reference positive cases, the posterior
distribution of <code class="reqn">\theta</code> is
</p>
<p style="text-align: center;"><code class="reqn">\theta | X=x ~ Beta(\alpha + x, \beta + n - x).</code>
</p>

<p>The posterior probability of exceeding the PG is then calculated as
</p>
<p><code class="reqn">P[\theta \ge sens_pg | X = x, n]</code>.
</p>
<p>A similar calculation can be performed for the specificity, with
corresponding PG, <code>spec_pg</code>.
</p>
<p><strong>Posterior predictive probability of eventual success</strong>
</p>
<p>When at an interim sample size that is less the maximum
(i.e. <code>max(n_at_looks)</code>), we can calculate the probability that the trial
will go on to eventually meet the success criteria.
</p>
<p>At the <code class="reqn">j</code>-th look, we have observed <code class="reqn">n_j</code> tests, with <code class="reqn">n_j^* =
n_{max} - n_j</code> subjects yet to be enrolled for testing. For the <code class="reqn">n_j^*</code>
subjects remaining, we can simulate the number of reference positive results,
<code class="reqn">y_j^*</code>, using the posterior predictive distribution for the prevalence
(reference positive tests), which is off the form
</p>
<p style="text-align: center;"><code class="reqn">y_j^* | y_j, n_j, n_j^* ~ Beta-Bin(n_j^*, \alpha_0 + y_j, \beta + n_j - y_j),</code>
</p>

<p>where <code class="reqn">y_j</code> is the observed number of reference positive cases.
Conditional on the number of subjects with a positive reference test in the
remaining sample together with <code class="reqn">n_j^*</code>, one can simulate the complete 2x2
contingency table by using the posterior predictive distributions for
sensitivity and specificity, each of which has a Beta-Binomial form.
Combining the observed <code class="reqn">n_j</code> subjects' data with a sample of the
<code class="reqn">n_j^*</code> subjects' data drawn from the predictive distribution, one can
then calculate the posterior probability of trial success (exceeding a PG)
for a specific endpoint. Repeating this many times and calculating the
proportion of probabilities that exceed the probability success threshold
yields the probability of eventual trial success at the maximum sample size.
</p>
<p>As well as calculating the predictive posterior probability of eventual
success for sensitivity and specificity, separately, we can also calculate
the probability for both endpoints simultaneously.
</p>


<h3>Value</h3>

<p>A list containing a data frame with rows for each stage of the trial
(i.e. each sample size look), irrespective of whether the trial meets the
stopping criteria. Multiple trial simulations are stacked longways and
indicated by the 'trial' column. The data frame has the following columns:
</p>

<ul>
<li>
<p><code>stage</code>: Trial stage.
</p>
</li>
<li>
<p><code>pp_sens</code>: Posterior probability of exceeding the performance
goal for sensitivity.
</p>
</li>
<li>
<p><code>pp_spec</code>: Posterior probability of exceeding the performance
goal for specificity.
</p>
</li>
<li>
<p><code>ppp_succ_sens</code>: Posterior predictive probability of eventual
success for sensitivity at the maximum sample size.
</p>
</li>
<li>
<p><code>ppp_succ_spec</code>: Posterior predictive probability of eventual
success for specificity at the maximum sample size.
</p>
</li>
<li>
<p><code>ppp_succ_both</code>: Posterior predictive probability of eventual
success for *both* sensitivity and specificity at the maximum sample
size.
</p>
</li>
<li>
<p><code>tp</code>: True positive count.
</p>
</li>
<li>
<p><code>tn</code>: True negative count.
</p>
</li>
<li>
<p><code>fp</code>: False positive count.
</p>
</li>
<li>
<p><code>fn</code>: False negative count.
</p>
</li>
<li>
<p><code>sens_hat</code>: Posterior median estimate of the test
sensitivity.
</p>
</li>
<li>
<p><code>sens_CrI2.5</code>: Lower bound of the 95
the test sensitivity.
</p>
</li>
<li>
<p><code>sens_CrI97.5</code>: Upper bound of the 95
the test sensitivity.
</p>
</li>
<li>
<p><code>spec_hat</code>: Posterior median estimate of the test
specificity.
</p>
</li>
<li>
<p><code>spec_CrI2.5</code>: Lower bound of the 95
the test specificity.
</p>
</li>
<li>
<p><code>spec_CrI97.5</code>: Upper bound of the 95
the test specificity.
</p>
</li>
<li>
<p><code>n</code>: The sample size at the given look for the row.
</p>
</li>
<li>
<p><code>trial</code>: The trial number, which will range from 1 to
'n_trials'.
</p>
</li>
</ul>
<p>The list also contains the arguments used and the call.
</p>


<h3>Parallelization</h3>

<p>To use multiple cores (where available), the argument <code>ncores</code> can be
increased from the default of 1. On UNIX machines (including macOS),
parallelization is performed using the <code>mclapply</code>
function with <code>ncores</code> <code class="reqn">&gt;1</code>. On Windows machines, parallel
processing is implemented via the <code>foreach</code> function.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
multi_trial(
  sens_true = 0.9,
  spec_true = 0.95,
  prev_true = 0.1,
  endpoint = "both",
  sens_pg = 0.8,
  spec_pg = 0.8,
  prior_sens = c(0.1, 0.1),
  prior_spec = c(0.1, 0.1),
  prior_prev = c(0.1, 0.1),
  succ_sens = 0.95,
  succ_spec = 0.95,
  n_at_looks = c(200, 400, 600, 800, 1000),
  n_mc = 10000,
  n_trials = 2,
  ncores = 1
)

</code></pre>


</div>