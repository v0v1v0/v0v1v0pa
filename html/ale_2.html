<div class="container">

<table style="width: 100%;"><tr>
<td>ale</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Create and return ALE data, statistics, and plots</h2>

<h3>Description</h3>

<p><code>ale()</code> is the central function that manages the creation of ALE data and plots
for one-way ALE. For two-way interactions, see <code>ale_ixn()</code>. This function calls
<code>ale_core</code> (a non-exported function) that manages the ALE data and plot creation in detail. For details, see
the introductory vignette for this package or the details and examples below.
</p>


<h3>Usage</h3>

<pre><code class="language-R">ale(
  data,
  model,
  x_cols = NULL,
  y_col = NULL,
  ...,
  parallel = parallel::detectCores(logical = FALSE) - 1,
  model_packages = as.character(NA),
  output = c("plots", "data", "stats", "conf_regions"),
  pred_fun = function(object, newdata, type = pred_type) {
     stats::predict(object =
    object, newdata = newdata, type = type)
 },
  pred_type = "response",
  p_values = NULL,
  p_alpha = c(0.01, 0.05),
  x_intervals = 100,
  boot_it = 0,
  seed = 0,
  boot_alpha = 0.05,
  boot_centre = "mean",
  relative_y = "median",
  y_type = NULL,
  median_band_pct = c(0.05, 0.5),
  rug_sample_size = 500,
  min_rug_per_interval = 1,
  ale_xs = NULL,
  ale_ns = NULL,
  compact_plots = FALSE,
  silent = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>dataframe. Dataset from which to create predictions for the ALE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>model object. Model for which ALE should be calculated.
May be any kind of R object that can make predictions from data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x_cols</code></td>
<td>
<p>character. Vector of column names from <code>data</code> for which
one-way ALE data is to be calculated (that is, simple ALE without interactions).
If not provided, ALE will be created for all columns in <code>data</code> except <code>y_col</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y_col</code></td>
<td>
<p>character length 1. Name of the outcome target label (y) variable.
If not provided, <code>ale()</code> will try to detect it automatically. For non-standard
models, <code>y_col</code> should be provided. For survival models, set <code>y_col</code> to the
name of the binary event column; in that case, <code>pred_type</code> should also be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>not used. Inserted to require explicit naming of subsequent arguments.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parallel</code></td>
<td>
<p>non-negative integer length 1. Number of parallel threads
(workers or tasks) for parallel execution of the function. See details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model_packages</code></td>
<td>
<p>character. Character vector of names of
packages that <code>model</code> depends on that might not be obvious.
The <code>{ale}</code> package should be able to automatically recognize and load most
packages that are needed, but with parallel processing enabled (which is the
default), some packages might not be properly loaded. If you get a strange error
message that mentions something somewhere about 'future', try adding the
package for your model to this vector, especially if you see such errors after
the progress bars begin displaying (assuming you did not disable progress bars
with <code>silent = TRUE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output</code></td>
<td>
<p>character in c('plots', 'data', 'stats', 'conf_regions'). Vector of types of results to return.
'plots' will return an ALE plot; 'data' will return the source ALE data;
'stats' will return ALE statistics. Each option must be listed to return the
specified component. By default, all are returned.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pred_fun, pred_type</code></td>
<td>
<p>function,character length 1. <code>pred_fun</code> is a function that
returns a vector of predicted values of type <code>pred_type</code> from <code>model</code> on <code>data</code>.
See details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p_values</code></td>
<td>
<p>instructions for calculating p-values and to determine the
median band. If <code>NULL</code> (default), no p-values are calculated and
<code>median_band_pct</code> is used to determine the median band.
To calculate p-values, an object generated by the
<code>create_p_funs()</code> function must be provided here. If <code>p_values</code> is set to 'auto',
this <code>ale()</code> function will try to automatically create the p-values function;
this only works with standard R model types. Any error message will be given
if p-values cannot be generated. Any other input provided to this argument
will result in an error. For more details about creating p-values,
see documentation for <code>create_p_funs()</code>. Note that p-values will not be
generated if 'stats' are not included as an option in the <code>output</code> argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p_alpha</code></td>
<td>
<p>numeric length 2 from 0 to 1. Alpha for "confidence interval" ranges
for printing bands around the median for single-variable plots. These are the
default values used if <code>p_values</code> are provided. If <code>p_values</code> are not provided,
then <code>median_band_pct</code> is used instead.
The inner band range will be the median value of y ± <code>p_alpha[2]</code> of the relevant
ALE statistic (usually ALE range or normalized ALE range).
For plots with a second outer band, its range will be the median ± <code>p_alpha[1]</code>.
For example, in the ALE plots, for the default <code>p_alpha = c(0.01, 0.05)</code>,
the inner band will be the median ± ALE minimum or maximum at p = 0.05 and
the outer band will be the median ± ALE minimum or maximum at p = 0.01.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x_intervals</code></td>
<td>
<p>positive integer length 1. Maximum number of intervals on the x-axis
for the ALE data for each column in <code>x_cols</code>. The number of intervals that the algorithm generates
might eventually be fewer than what the user specifies if the data values for
a given x value do not support that many intervals.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boot_it</code></td>
<td>
<p>non-negative integer length 1. Number of bootstrap iterations for the
ALE values. If <code>boot_it = 0</code> (default), then ALE will be calculated on the entire dataset
with no bootstrapping.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>integer length 1. Random seed. Supply this between runs to assure that
identical random ALE data is generated each time</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boot_alpha</code></td>
<td>
<p>numeric length 1 from 0 to 1. Alpha for percentile-based confidence
interval range for the bootstrap intervals; the bootstrap confidence intervals
will be the lowest and highest <code>(1 - 0.05) / 2</code> percentiles. For example,
if <code>boot_alpha = 0.05</code> (default), the intervals will be from the 2.5 and 97.5
percentiles.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boot_centre</code></td>
<td>
<p>character length 1 in c('mean', 'median'). When bootstrapping, the
main estimate for <code>ale_y</code> is considered to be <code>boot_centre</code>. Regardless of the
value specified here, both the mean and median will be available.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>relative_y</code></td>
<td>
<p>character length 1 in c('median', 'mean', 'zero'). The ale_y values will
be adjusted relative to this value. 'median' is the default. 'zero' will maintain the
default of <code>ALEPlot::ALEPlot()</code>, which is not shifted.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y_type</code></td>
<td>
<p>character length 1. Datatype of the y (outcome) variable.
Must be one of c('binary', 'numeric', 'multinomial', 'ordinal'). Normally
determined automatically; only provide for complex non-standard models that
require it.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>median_band_pct</code></td>
<td>
<p>numeric length 2 from 0 to 1. Alpha for "confidence interval" ranges
for printing bands around the median for single-variable plots. These are the
default values used if <code>p_values</code> are not provided. If <code>p_values</code> are provided,
then <code>median_band_pct</code> is ignored.
The inner band range will be the median value of y ± <code>median_band_pct[1]/2</code>.
For plots with a second outer band, its range will be the median ± <code>median_band_pct[2]/2</code>.
For example, for the default <code>median_band_pct = c(0.05, 0.5)</code>, the inner band
will be the median ± 2.5% and the outer band will be the median ± 25%.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rug_sample_size, min_rug_per_interval</code></td>
<td>
<p>single non-negative integer length 1.
Rug plots are normally
down-sampled otherwise they are too slow. <code>rug_sample_size</code> specifies the size
of this sample. To prevent down-sampling, set to <code>Inf</code>. To suppress rug plots,
set to 0. When down-sampling, the rug plots maintain representativeness of the
data by guaranteeing that each of the <code>x_intervals</code> intervals will retain at least
<code>min_rug_per_interval</code> elements; usually set to just 1 or 2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ale_xs, ale_ns</code></td>
<td>
<p>list of ale_x and ale_n vectors. If provided, these vectors will be used to
set the intervals of the ALE x axis for each variable. By default (NULL), the
function automatically calculates the ale_x intervals. <code>ale_xs</code> is normally used
in advanced analyses where the ale_x intervals from a previous analysis are
reused for subsequent analyses (for example, for full model bootstrapping;
see the <code>model_bootstrap()</code> function).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>compact_plots</code></td>
<td>
<p>logical length 1, default <code>FALSE</code>. When <code>output</code> includes
'plots', the returned <code>ggplot</code> objects each include the environments of the plots.
This lets the user modify the plots with all the flexibility of <code>ggplot</code>, but it
can result in very large return objects (sometimes even hundreds of megabytes
large). To compact the plots to their bare minimum, set <code>compact_plots = TRUE</code>.
However, returned plots will not be easily modifiable, so this should only be
used if you do not want to subsequently modify the plots.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>silent</code></td>
<td>
<p>logical length 1, default <code>FALSE.</code> If <code>TRUE</code>, do not display any
non-essential messages during execution (such as progress bars).
Regardless, any warnings and errors will always display. See details for how
to enable progress bars.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>ale_core.R
</p>
<p>Core functions for the ale package: ale, ale_ixn, and ale_core
</p>


<h3>Value</h3>

<p>list with the following elements:
</p>

<ul>
<li> <p><code>data</code>: a list whose elements, named by each requested x variable, are each
a tibble with the following columns:
</p>

<ul>
<li> <p><code>ale_x</code>: the values of each of the ALE x intervals or categories.
</p>
</li>
<li> <p><code>ale_n</code>: the number of rows of data in each <code>ale_x</code> interval or category.
</p>
</li>
<li> <p><code>ale_y</code>: the ALE function value calculated for that interval or category.
For bootstrapped ALE, this is the same as <code>ale_y_mean</code> by default
or <code>ale_y_median</code> if the <code>boot_centre = 'median'</code> argument is specified.
Regardless, both <code>ale_y_mean</code> and <code>ale_y_median</code> are returned as columns here.
</p>
</li>
<li> <p><code>ale_y_lo</code>, <code>ale_y_hi</code>: the lower and upper confidence intervals, respectively,
for the bootstrapped <code>ale_y</code> value.
Note: regardless what options are requested in the <code>output</code> argument, this
<code>data</code> element is always returned.
</p>
</li>
</ul>
</li>
<li> <p><code>stats</code>: if <code>stats</code> are requested in the <code>output</code> argument (as is the default),
returns a list. If not requested, returns <code>NULL</code>. The returned list provides
ALE statistics of the <code>data</code> element duplicated and presented from various
perspectives in the following elements:
</p>

<ul>
<li> <p><code>by_term</code>: a list named by each requested x variable, each of whose elements
is a tibble with the following columns:
</p>

<ul>
<li> <p><code>statistic</code>: the ALE statistic specified in the row (see
the <code>by_statistic</code> element below).
</p>
</li>
<li> <p><code>estimate</code>: the bootstrapped <code>mean</code> or <code>median</code> of the <code>statistic</code>,
depending on the <code>boot_centre</code> argument to the <code>ale()</code> function.
Regardless, both <code>mean</code> and <code>median</code> are returned as columns here.
</p>
</li>
<li> <p><code>conf.low</code>, <code>conf.high</code>: the lower and upper confidence intervals,
respectively, for the bootstrapped <code>estimate</code>.
</p>
</li>
</ul>
</li>
<li> <p><code>by_statistic</code>: list named by each of the following ALE statistics:
<code>aled</code>, <code>aler_min</code>, <code>aler_max</code>, <code>naled</code>, <code>naler_min</code>, <code>naler_max</code>. See
<code>vignette('ale-statistics')</code> for details.
</p>
</li>
<li> <p><code>estimate</code>: a tibble whose data consists of the <code>estimate</code> values from the
<code>by_term</code> element above. The columns are <code>term</code> (the variable name) and the
statistic for which the estimate is given:
<code>aled</code>, <code>aler_min</code>, <code>aler_max</code>, <code>naled</code>, <code>naler_min</code>, <code>naler_max</code>.
</p>
</li>
<li> <p><code>effects_plot</code>: a <code>ggplot</code> object which is the ALE effects plot for all the
x variables.
</p>
</li>
</ul>
</li>
<li> <p><code>plots</code>: if <code>plots</code> are requested in the <code>output</code> argument (as is the default),
returns a list whose elements, named by each requested x variable, are each
a <code>ggplot</code> object of the ALE y values plotted against the x variable intervals.
If <code>plots</code> is not included in <code>output</code>, this element is <code>NULL</code>.
</p>
</li>
<li> <p><code>conf_regions</code>: if <code>conf_regions</code> are requested in the <code>output</code> argument (as is the default),
returns a list. If not requested, returns <code>NULL</code>. The returned list provides
summaries of the confidence regions of the relevant ALE statistics of the <code>data</code>
element.
The list has the following elements:
</p>

<ul>
<li> <p><code>by_term</code>: a list named by each requested x variable, each of whose elements
is a tibble with the relevant data for the confidence regions.
(See <code>vignette('ale-statistics')</code> for details about confidence regions.)
</p>
</li>
<li> <p><code>significant</code>: a tibble that summarizes the <code>by_term</code> to only show confidence
regions that are statistically significant. Its columns are those from
<code>by_term</code> plus a <code>term</code> column to specify which x variable is indicated
by the respective row.
</p>
</li>
<li> <p><code>sig_criterion</code>: a length-one character vector that reports which values
were used to determine statistical significance: if <code>p_values</code> was
provided to the <code>ale()</code> function, it will be used; otherwise,
<code>median_band_pct</code> will be used.
</p>
</li>
</ul>
</li>
<li>
<p> Various values echoed from the original call to the <code>ale()</code> function, provided
to document the key elements used to calculate the ALE data, statistics, and plots:
<code>y_col</code>, <code>x_cols</code>, <code>boot_it</code>, <code>seed</code>, <code>boot_alpha</code>, <code>boot_centre</code>, <code>relative_y</code>,
<code>y_type</code>, <code>median_band_pct</code>, <code>rug_sample_size</code>. These are either the values
provided by the user or used by default if the user did not change them.
</p>
</li>
<li> <p><code>y_summary</code>: summary statistics of y values used for the ALE calculation.
These statistics are based on the actual values of <code>y_col</code> unless if <code>y_type</code> is a
probability or other value that is constrained in the <code style="white-space: pre;">⁠[0, 1]⁠</code> range. In that
case, <code>y_summary</code> is based on the predicted values of <code>y_col</code> by applying
<code>model</code> to the <code>data</code>. <code>y_summary</code> is a named numeric vector. Most of the
elements are the percentile of the y values. E.g., the '5%' element is the
5th percentile of y values. The following elements have special meanings:
</p>

<ul>
<li>
<p> The first element is named either <code>p</code> or <code>q</code> and its value is always 0.
The value is not used; only the name of the element is meaningful.
<code>p</code> means that the following special <code>y_summary</code> elements are based on
the provided <code>p_values</code> object. <code>q</code> means that quantiles were calculated
based on <code>median_band_pct</code> because <code>p_values</code> was not provided.
</p>
</li>
<li> <p><code>min</code>, <code>mean</code>, <code>max</code>: the minimum, mean, and maximum y values, respectively.
Note that the median is <code style="white-space: pre;">⁠50%⁠</code>, the 50th percentile.
</p>
</li>
<li> <p><code>med_lo_2</code>, <code>med_lo</code>, <code>med_hi</code>, <code>med_hi_2</code>: <code>med_lo</code> and <code>med_hi</code> are the
inner lower and upper confidence intervals of y values with respect to
the median (<code style="white-space: pre;">⁠50%⁠</code>); <code>med_lo_2</code> and <code>med_hi_2</code> are the outer confidence
intervals. See the documentation for the <code>p_alpha</code> and <code>median_band_pct</code>
arguments to understand how these are determined.
</p>
</li>
</ul>
</li>
</ul>
<h3>Custom predict function</h3>

<p>The calculation of ALE requires modifying several values of the original
<code>data</code>. Thus, <code>ale()</code> needs direct access to a <code>predict</code> function that work on
<code>model</code>. By default, <code>ale()</code> uses a generic default <code>predict</code> function of the form
<code>predict(object, newdata, type)</code> with the default prediction type of 'response'.
If, however, the desired prediction values are not generated with that format,
the user must specify what they want. Most of the time, the only modification needed is
to change the prediction type to some other value by setting the <code>pred_type</code> argument
(e.g., to 'prob' to generated classification probabilities). But if the desired
predictions need a different function signature, then the user must create a
custom prediction function and pass it to <code>pred_fun</code>. The requirements for this
custom function are:
</p>

<ul>
<li>
<p> It must take three required arguments and nothing else:
</p>

<ul>
<li> <p><code>object</code>: a model
</p>
</li>
<li> <p><code>newdata</code>: a dataframe or compatible table type
</p>
</li>
<li> <p><code>type</code>: a string; it should usually be specified as <code>type = pred_type</code>
These argument names are according to the R convention for the
generic stats::predict function.
</p>
</li>
</ul>
</li>
<li>
<p> It must return a vector of numeric values as the prediction.
</p>
</li>
</ul>
<p>You can see an example below of a custom prediction function.
</p>
<p><strong>Note:</strong> <code>survival</code> models probably do not need a custom prediction function
but <code>y_col</code> must be set to the name of the binary event column and
<code>pred_type</code> must be set to the desired prediction type.
</p>


<h3>ALE statistics</h3>

<p>For details about the ALE-based statistics (ALED, ALER, NALED, and NALER), see
<code>vignette('ale-statistics')</code>.
</p>


<h3>Parallel processing</h3>

<p>Parallel processing using the <code>{furrr}</code> library is enabled by default. By default,
it will use all the available physical
CPU cores (minus the core being used for the current R session) with the setting
<code>parallel = parallel::detectCores(logical = FALSE) - 1</code>. Note that only
physical cores are used (not logical cores or "hyperthreading") because
machine learning can only take advantage of the floating point processors on
physical cores, which are absent from logical cores. Trying to use logical
cores will not speed up processing and might actually slow it down with useless
data transfer. If you will dedicate
the entire computer to running this function (and you don't mind everything
else becoming very slow while it runs), you may use all cores by setting
<code>parallel = parallel::detectCores(logical = FALSE)</code>. To disable parallel
processing, set <code>parallel = 0</code>.
</p>


<h3>Progress bars</h3>

<p>Progress bars are implemented with the <code>{progressr}</code> package, which lets
the user fully control progress bars. <strong>To disable progress bars, set <code>silent = TRUE</code>.</strong>
The first time a function is called in
the <code>{ale}</code> package that requires progress bars, it checks if the user has
activated the necessary <code>{progressr}</code> settings. If not, the <code>{ale}</code> package
automatically enables <code>{progressr}</code> progress bars with the <code>cli</code> handler and
prints a message notifying the user.
</p>
<p>If you like the default progress bars and you want to make them permanent, then you
can <a href="https://support.posit.co/hc/en-us/articles/360047157094-Managing-R-with-Rprofile-Renviron-Rprofile-site-Renviron-site-rsession-conf-and-repos-conf">add the following lines of code to your .Rprofile configuration file</a>
and they will become your defaults for every R session; you will not see the
message again:
</p>
<div class="sourceCode R"><pre>progressr::handlers(global = TRUE)
progressr::handlers('cli')
</pre></div>
<p>For more details on formatting progress bars to your liking, see the introduction
to the <a href="https://progressr.futureverse.org/articles/progressr-intro.html"><code>{progressr}</code> package</a>.
</p>


<h3>References</h3>

<p>Okoli, Chitu. 2023.
“Statistical Inference Using Machine Learning and Classical Techniques Based
on Accumulated Local Effects (ALE).” arXiv. <a href="https://arxiv.org/abs/2310.09877">https://arxiv.org/abs/2310.09877</a>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">set.seed(0)
diamonds_sample &lt;- ggplot2::diamonds[sample(nrow(ggplot2::diamonds), 1000), ]

# Create a GAM model with flexible curves to predict diamond price
# Smooth all numeric variables and include all other variables
gam_diamonds &lt;- mgcv::gam(
  price ~ s(carat) + s(depth) + s(table) + s(x) + s(y) + s(z) +
    cut + color + clarity,
  data = diamonds_sample
)
summary(gam_diamonds)




# Simple ALE without bootstrapping
ale_gam_diamonds &lt;- ale(
  diamonds_sample, gam_diamonds,
  parallel = 2  # CRAN limit (delete this line on your own computer)
)

# Plot the ALE data
ale_gam_diamonds$plots |&gt;
  patchwork::wrap_plots()

# Bootstrapped ALE
# This can be slow, since bootstrapping runs the algorithm boot_it times

# Create ALE with 100 bootstrap samples
ale_gam_diamonds_boot &lt;- ale(
  diamonds_sample, gam_diamonds, boot_it = 100,
  parallel = 2  # CRAN limit (delete this line on your own computer)
)

# Bootstrapped ALEs print with confidence intervals
ale_gam_diamonds_boot$plots |&gt;
  patchwork::wrap_plots()


# If the predict function you want is non-standard, you may define a
# custom predict function. It must return a single numeric vector.
custom_predict &lt;- function(object, newdata, type = pred_type) {
  predict(object, newdata, type = type, se.fit = TRUE)$fit
}

ale_gam_diamonds_custom &lt;- ale(
  diamonds_sample, gam_diamonds,
  pred_fun = custom_predict, pred_type = 'link',
  parallel = 2  # CRAN limit (delete this line on your own computer)
)

# Plot the ALE data
ale_gam_diamonds_custom$plots |&gt;
  patchwork::wrap_plots()




</code></pre>


</div>