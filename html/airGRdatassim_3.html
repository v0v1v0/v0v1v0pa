<div class="container">

<table style="width: 100%;"><tr>
<td>CreateInputsPert</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Generation of ensemble model inputs for data assimilation</h2>

<h3>Description</h3>

<p>Function which perturbs the model inputs to generate probabilistic meteorological forcings required to perform ensemble-based data assimilation.
</p>


<h3>Usage</h3>

<pre><code class="language-R">CreateInputsPert(FUN_MOD, DatesR, Precip = NULL,
                 PotEvap = NULL, TempMean = NULL,
                 ZInputs = NULL, HypsoData = NULL, NLayers = 5,
                 NbMbr = 50, Seed = NULL)

## S3 method for class 'InputsPert'
x[i]

## S3 method for class 'InputsPert'
plot(x, which = "all", main = NULL,
     ColPrecip = "royalblue", ColPotEvap = "green3",
     ask = prod(par("mfcol")) &lt; length(which) &amp;&amp; dev.interactive(), ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>FUN_MOD</code></td>
<td>
<p>[function] hydrological model function (e.g. <code>RunModel_GR5J</code>, <code>RunModel_CemaNeigeGR5J</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DatesR</code></td>
<td>
<p>[POSIXct] vector of dates</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Precip</code></td>
<td>
<p>(optional) [numeric] time series of total precipitation to perturb [mm/d]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>PotEvap</code></td>
<td>
<p>(optional) [numeric] time series of potential evapotranspiration to perturb [mm/d]</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>TempMean</code></td>
<td>
<p>(optional) [numeric] time series of mean air temperature [Â°C] (not perturbed), required to create the CemaNeige module inputs</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ZInputs</code></td>
<td>
<p>(optional) [numeric] real giving the mean elevation of the Precip and Temp series (before extrapolation) [m], possibly used to create the CemaNeige module inputs</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>HypsoData</code></td>
<td>
<p>(optional) [numeric] vector of 101 reals: min, q01 to q99 and max of catchment elevation distribution [m], if not defined a single elevation is used for CemaNeige</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>NLayers</code></td>
<td>
<p>(optional) [numeric] integer giving the number of elevation layers requested [-], required to create CemaNeige module inputs, default=5</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>NbMbr</code></td>
<td>
<p>(optional) [numeric] number of ensemble members (minimum of 20 recommanded for the EnKF scheme and of 30 for the PF scheme)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Seed</code></td>
<td>
<p>(optional) [numeric] seed of random number generator</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>[InputsPert] containing the vector of dates (<em>POSIXt</em>) and the time series of numeric values list perturbed</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>i</code></td>
<td>
<p>[integer] of the indices to subset a time series or [character] names of the elements to extract</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>which</code></td>
<td>
<p>(optional) [character] choice of plots (e.g. <code>"Precip"</code> or <code>"PotEvap"</code>, default = <code>"all"</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>main</code></td>
<td>
<p>(optional) [character] an overall title for the plot (see <code>title</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ColPrecip, ColPotEvap</code></td>
<td>
<p>(optional) [character] color to be used for perturbed precipitation and perturbed potential evapotransipration (in any format that <code>col2rgb</code> accepts)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ask</code></td>
<td>
<p>(optional) [logical] if <code>TRUE</code>, the user is asked before each plot, see <code>par(ask = .)</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>other parameters to be passed through to plotting functions</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The function generates an ensemble of precipitation or/and potential evapotranspiration time series, from data provided as function argument/s. The mean air temperature required to create CemaNeige inputs is not perturbed.
<br><br>
Probabilistic forcing/s is/are generated by stochastically perturbing the meteorological variable/s through a multiplicative stochastic noise, according to the methodology proposed by Clark et al. (2008).
<br><br>
The random perturbations are provided through a first-order autoregressive model relying on a fractional error parameter equal to 0.65 and a temporal decorrelation length of 1 day for rainfall and 2 days for potential evapotranspiration.
<br><br>
In order to ensure reproducible results, <em>Seed</em> can be set to fix the randomness in the generation of perturbations.
<br><br>
For further details, see the references section.
<br><br>
Nota: The function can be applied when using GR4J, GR5J and GR6J models (i.e. daily model time step), with or withouth the CemaNeige module.
</p>
<p>On the graphical outputs: <br>
- solid line: medians of the input values <br>
- polygon: minima and maxima of the input values <br></p>


<h3>Value</h3>

<p><em>InputsPert</em>[list] object of class <em>InputsModel</em> containing the ensembles of perturbed model inputs required to perform data assimilation:
</p>

<table>
<tr>
<td style="text-align: left;">
     <em>$DatesR </em> </td>
<td style="text-align: left;"> [POSIXlt] vector of dates
                          </td>
</tr>
<tr>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">
     <em>$Precip </em> </td>
<td style="text-align: left;"> [numeric] matrix (dim(NbTime, NbMbr)) of ensemblist time series of perturbed total precipitation [mm/d] (with NbTime the length of the period; generated only if the precipitation time series is provided as a function argument)
                          </td>
</tr>
<tr>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">
     <em>$PotEvap</em> </td>
<td style="text-align: left;"> [numeric] matrix (dim(NbTime, NbMbr)) of ensemblist time series of perturbed potential evapotranspiration [mm/d] (generated only if the time series of potential evapotranspiration is provided as a function argument)
                          </td>
</tr>
<tr>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">
     <em>$NbMbr  </em> </td>
<td style="text-align: left;"> [integer] atomic vector of number of ensemble members
  </td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Gaia Piazzi, Olivier Delaigue
</p>


<h3>References</h3>

<p>- Clark, M. P., Rupp, D. E., Woods, R. A., Zheng, X., Ibbitt, R. P., Slater, A. G. et al. (2008). Hydrological data assimilation with the ensemble Kalman filter: Use of streamflow observations to update states in a distributed hydrological model. Advances in Water Resources, 31(10), 1309-1324, doi: <a href="https://doi.org/10.1016/j.advwatres.2008.06.005">10.1016/j.advwatres.2008.06.005</a>
<br><br>
- Piazzi, G., Thirel, G., Perrin, C. and Delaigue, O. (accepted). Sequential data assimilation for streamflow forecasting: assessing the sensitivity to uncertainties and updated variables of a conceptual hydrological model. Water Resources Research, doi: <a href="https://doi.org/10.1029/2020WR028390">10.1029/2020WR028390</a>.
</p>


<h3>See Also</h3>

<p><code>RunModel_DA</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(airGRdatassim)

## loading catchment data
data(L0123001, package = "airGR")

## preparation of the InputsModel object
InputsModel &lt;- CreateInputsModel(FUN_MOD = RunModel_GR5J, DatesR = BasinObs$DatesR,
                                 Precip = BasinObs$P, PotEvap = BasinObs$E)

## run period selection
IndRun &lt;- seq(which(format(BasinObs$DatesR, format = "%Y-%m-%d")=="2006-01-01"),
              which(format(BasinObs$DatesR, format = "%Y-%m-%d")=="2006-01-31"))

## preparation of perturbed meteorological ensemble
InputsPert &lt;- CreateInputsPert(FUN_MOD = RunModel_GR5J,
                               DatesR = BasinObs$DatesR,
                               Precip = BasinObs$P,
                               PotEvap = BasinObs$E,
                               NbMbr = 100L)
str(InputsPert)

## results preview
oldpar &lt;- par(mfrow = c(2, 1))
plot(InputsPert)
par(oldpar)

## results preview on a subset on one perturbed variable
oldpar &lt;- par(mfrow = c(1, 1))
plot(InputsPert[IndRun], which = "PotEvap")
par(oldpar)
</code></pre>


</div>