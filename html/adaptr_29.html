<div class="container">

<table style="width: 100%;"><tr>
<td>plot_convergence</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Plot convergence of performance metrics</h2>

<h3>Description</h3>

<p>Plots performance metrics according to the number of simulations conducted
for multiple simulated trials. The simulated trial results may be split into
a number of batches to illustrate stability of performance metrics across
different simulations. Calculations are done according to specified selection
and restriction strategies as described in <code>extract_results()</code> and
<code>check_performance()</code>. Requires the <code>ggplot2</code> package installed.
</p>


<h3>Usage</h3>

<pre><code class="language-R">plot_convergence(
  object,
  metrics = "size mean",
  resolution = 100,
  select_strategy = "control if available",
  select_last_arm = FALSE,
  select_preferences = NULL,
  te_comp = NULL,
  raw_ests = FALSE,
  final_ests = NULL,
  restrict = NULL,
  n_split = 1,
  nrow = NULL,
  ncol = NULL,
  cores = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p><code>trial_results</code> object, output from the <code>run_trials()</code>
function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>metrics</code></td>
<td>
<p>the performance metrics to plot, as described in
<code>check_performance()</code>. Multiple metrics may be plotted at the same time.
Valid metrics include: <code>size_mean</code>, <code>size_sd</code>, <code>size_median</code>, <code>size_p25</code>,
<code>size_p75</code>, <code>size_p0</code>, <code>size_p100</code>, <code>sum_ys_mean</code>, <code>sum_ys_sd</code>,
<code>sum_ys_median</code>, <code>sum_ys_p25</code>, <code>sum_ys_p75</code>, <code>sum_ys_p0</code>, <code>sum_ys_p100</code>,
<code>ratio_ys_mean</code>, <code>ratio_ys_sd</code>, <code>ratio_ys_median</code>, <code>ratio_ys_p25</code>,
<code>ratio_ys_p75</code>, <code>ratio_ys_p0</code>, <code>ratio_ys_p100</code>, <code>prob_conclusive</code>,
<code>prob_superior</code>, <code>prob_equivalence</code>, <code>prob_futility</code>, <code>prob_max</code>,
<code style="white-space: pre;">⁠prob_select_*⁠</code> (with <code>*</code> being either "<code style="white-space: pre;">⁠arm_&lt;name&gt;⁠</code> for all <code>arm</code> names or
<code>none</code>), <code>rmse</code>, <code>rmse_te</code>, <code>mae</code>, <code>mae_te</code>, and <code>idp</code>. All may be
specified as above, case sensitive, but with either spaces or underlines.
Defaults to <code>"size mean"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>resolution</code></td>
<td>
<p>single positive integer, the number of points calculated
and plotted, defaults to <code>100</code> and must be <code style="white-space: pre;">⁠&gt;= 10⁠</code>. Higher numbers lead to
smoother plots, but increases computation time. If the value specified is
higher than the number of simulations (or simulations per split), the
maximum possible value will be used instead.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>select_strategy</code></td>
<td>
<p>single character string. If a trial was not stopped
due to superiority (or had only 1 arm remaining, if <code>select_last_arm</code> is
set to <code>TRUE</code> in trial designs with a common <code>control</code> arm; see below),
this parameter specifies which arm will be considered selected when
calculating trial design performance metrics, as described below;
this corresponds to the consequence of an inconclusive trial, i.e., which
arm would then be used in practice.<br>
The following options are available and must be written exactly as below
(case sensitive, cannot be abbreviated):
</p>

<ul>
<li> <p><code>"control if available"</code> (default): selects the <strong>first</strong>
<code>control</code> arm for trials with a common <code>control</code> arm <em><strong>if</strong></em> this
arm is active at end-of-trial, otherwise no arm will be selected. For
trial designs without a common <code>control</code>, no arm will be selected.
</p>
</li>
<li> <p><code>"none"</code>: selects no arm in trials not ending with superiority.
</p>
</li>
<li> <p><code>"control"</code>: similar to <code>"control if available"</code>, but will throw
an error if used for trial designs without a common <code>control</code> arm.
</p>
</li>
<li> <p><code>"final control"</code>: selects the <strong>final</strong> <code>control</code> arm regardless
of whether the trial was stopped for practical equivalence, futility,
or at the maximum sample size; this strategy can only be specified
for trial designs with a common <code>control</code> arm.
</p>
</li>
<li> <p><code>"control or best"</code>: selects the <strong>first</strong> <code>control</code> arm if still
active at end-of-trial, otherwise selects the best remaining arm
(defined as the remaining arm with the highest probability of being
the best in the last adaptive analysis conducted). Only works for
trial designs with a common <code>control</code> arm.
</p>
</li>
<li> <p><code>"best"</code>: selects the best remaining arm (as described under
<code>"control or best"</code>).
</p>
</li>
<li> <p><code>"list or best"</code>: selects the first remaining arm from a specified
list (specified using <code>select_preferences</code>, technically a character
vector). If none of these arms are are active at end-of-trial, the best
remaining arm will be selected (as described above).
</p>
</li>
<li> <p><code>"list"</code>: as specified above, but if no arms on the provided list
remain active at end-of-trial, no arm is selected.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>select_last_arm</code></td>
<td>
<p>single logical, defaults to <code>FALSE</code>. If <code>TRUE</code>, the
only remaining active arm (the last <code>control</code>) will be selected in trials
with a common <code>control</code> arm ending with <code>equivalence</code> or <code>futility</code>, before
considering the options specified in <code>select_strategy</code>. Must be <code>FALSE</code> for
trial designs without a common <code>control</code> arm.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>select_preferences</code></td>
<td>
<p>character vector specifying a number of arms used
for selection if one of the <code>"list or best"</code> or <code>"list"</code> options are
specified for <code>select_strategy</code>. Can only contain valid <code>arms</code>
available in the trial.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>te_comp</code></td>
<td>
<p>character string, treatment-effect comparator. Can be either
<code>NULL</code> (the default) in which case the <strong>first</strong> <code>control</code> arm is used for
trial designs with a common control arm, or a string naming a single trial
<code>arm</code>. Will be used when calculating <code>err_te</code> and <code>sq_err_te</code> (the error
and the squared error of the treatment effect comparing the selected arm to
the comparator arm, as described below).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>raw_ests</code></td>
<td>
<p>single logical. If <code>FALSE</code> (default), the
posterior estimates (<code>post_ests</code> or <code>post_ests_all</code>, see <code>setup_trial()</code>
and <code>run_trial()</code>) will be used to calculate <code>err</code> and <code>sq_err</code> (the error
and the squared error of the estimated compared to the specified effect in
the selected arm) and <code>err_te</code> and <code>sq_err_te</code> (the error and the squared
error of the treatment effect comparing the selected arm to the comparator
arm, as described for <code>te_comp</code> and below). If <code>TRUE</code>, the raw estimates
(<code>raw_ests</code> or <code>raw_ests_all</code>, see <code>setup_trial()</code> and <code>run_trial()</code>) will
be used instead of the posterior estimates.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>final_ests</code></td>
<td>
<p>single logical. If <code>TRUE</code> (recommended) the final estimates
calculated using outcome data from all patients randomised when trials are
stopped are used (<code>post_ests_all</code> or <code>raw_ests_all</code>, see <code>setup_trial()</code>
and <code>run_trial()</code>); if <code>FALSE</code>, the estimates calculated for each arm when
an arm is stopped (or at the last adaptive analysis if not before) using
data from patients having reach followed up at this time point and not all
patients randomised are used (<code>post_ests</code> or <code>raw_ests</code>, see
<code>setup_trial()</code> and <code>run_trial()</code>). If <code>NULL</code> (the default), this argument
will be set to <code>FALSE</code> if outcome data are available immediate after
randomisation for all patients (for backwards compatibility, as final
posterior estimates may vary slightly in this situation, even if using the
same data); otherwise it will be said to <code>TRUE</code>. See <code>setup_trial()</code> for
more details on how these estimates are calculated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>restrict</code></td>
<td>
<p>single character string or <code>NULL</code>. If <code>NULL</code> (default),
results are summarised for all simulations; if <code>"superior"</code>, results are
summarised for simulations ending with superiority only; if <code>"selected"</code>,
results are summarised for simulations ending with a selected arm only
(according to the specified arm selection strategy for simulations not
ending with superiority). Some summary measures (e.g., <code>prob_conclusive</code>)
have substantially different interpretations if restricted, but are
calculated nonetheless.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n_split</code></td>
<td>
<p>single positive integer, the number of consecutive batches the
simulation results will be split into, which will be plotted separately.
Default is <code>1</code> (no splitting); maximum value is the number of simulations
summarised (after restrictions) divided by 10.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nrow, ncol</code></td>
<td>
<p>the number of rows and columns when plotting multiple
metrics in the same plot (using faceting in <code>ggplot2</code>). Defaults to <code>NULL</code>,
in which case this will be determined automatically.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cores</code></td>
<td>
<p><code>NULL</code> or single integer. If <code>NULL</code>, a default value set by
<code>setup_cluster()</code> will be used to control whether extractions of simulation
results are done in parallel on a default cluster or sequentially in the
main process; if a value has not been specified by <code>setup_cluster()</code>,
<code>cores</code> will then be set to the value stored in the global <code>"mc.cores"</code>
option (if previously set by <code style="white-space: pre;">⁠options(mc.cores = &lt;number of cores&gt;⁠</code>), and
<code>1</code> if that option has not been specified.<br>
If <code>cores = 1</code>, computations
will be run sequentially in the primary process, and if <code>cores &gt; 1</code>, a new
parallel cluster will be setup using the <code>parallel</code> library and removed
once the function completes. See <code>setup_cluster()</code> for details.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A <code>ggplot2</code> plot object.
</p>


<h3>See Also</h3>

<p><code>check_performance()</code>, <code>summary()</code>, <code>extract_results()</code>,
<code>check_remaining_arms()</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">#### Only run examples if ggplot2 is installed ####
if (requireNamespace("ggplot2", quietly = TRUE)){

  # Setup a trial specification
  binom_trial &lt;- setup_trial_binom(arms = c("A", "B", "C", "D"),
                                   control = "A",
                                   true_ys = c(0.20, 0.18, 0.22, 0.24),
                                   data_looks = 1:20 * 100)

  # Run multiple simulation with a fixed random base seed
  res_mult &lt;- run_trials(binom_trial, n_rep = 25, base_seed = 678)

  # NOTE: the number of simulations in this example is smaller than
  # recommended - the plots reflect that, and show that performance metrics
  # are not stable and have likely not converged yet

  # Convergence plot of mean sample sizes
  plot_convergence(res_mult, metrics = "size mean")

}

if (requireNamespace("ggplot2", quietly = TRUE)){

  # Convergence plot of mean sample sizes and ideal design percentages,
  # with simulations split in 2 batches
  plot_convergence(res_mult, metrics = c("size mean", "idp"), n_split = 2)

}

</code></pre>


</div>