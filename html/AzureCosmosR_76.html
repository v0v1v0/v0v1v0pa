<div class="container">

<table style="width: 100%;"><tr>
<td>query_documents</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Query an Azure Cosmos DB container</h2>

<h3>Description</h3>

<p>Query an Azure Cosmos DB container
</p>


<h3>Usage</h3>

<pre><code class="language-R">query_documents(container, ...)

## S3 method for class 'cosmos_container'
query_documents(
  container,
  query,
  parameters = list(),
  cross_partition = TRUE,
  partition_key = NULL,
  by_pkrange = FALSE,
  as_data_frame = TRUE,
  metadata = TRUE,
  headers = list(),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>container</code></td>
<td>
<p>A Cosmos DB container object, as obtained by <code>get_cosmos_container</code> or <code>create_cosmos_container</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>query</code></td>
<td>
<p>A string containing the query text.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parameters</code></td>
<td>
<p>A named list of parameters to pass to a parameterised query, if required.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cross_partition, partition_key, by_pkrange</code></td>
<td>
<p>Arguments that control how to handle cross-partition queries. See 'Details' below.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>as_data_frame</code></td>
<td>
<p>Whether to return the query result as a data frame, or a list of Cosmos DB document objects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>metadata</code></td>
<td>
<p>Whether to include Cosmos DB document metadata in the query result.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>headers, ...</code></td>
<td>
<p>Optional arguments passed to lower-level functions.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This is the primary function for querying the contents of a Cosmos DB container (table). The <code>query</code> argument should contain the text of a SQL query, optionally parameterised. if the query contains parameters, pass them in the <code>parameters</code> argument as a named list.
</p>
<p>Cosmos DB is a partitioned key-value store under the hood, with documents stored in separate physical databases according to their value of the partition key. The Cosmos DB REST API has limited support for cross-partition queries: basic SELECTs should work, but aggregates and more complex queries may require some hand-hacking.
</p>
<p>The default <code>cross_partition=TRUE</code> runs the query for all partition key values and then attempts to stitch the results together. To run the query for only one key value, set <code>cross_partition=FALSE</code> and <code>partition_key</code> to the desired value. You can obtain all the values of the key with the list_partition_key_values function.
</p>
<p>The <code>by_pkrange</code> argument allows running the query separately across all <em>partition key ranges</em>. Each partition key range corresponds to a separate physical partition, and contains the documents for one or more key values. You can set this to TRUE to run a query that fails when run across partitions; the returned object will be a list containing the individual query results from each pkrange.
</p>
<p>As an alternative to AzureCosmosR, you can also use the ODBC protocol to interface with the SQL API. By installing a suitable ODBC driver, you can then talk to Cosmos DB in a manner similar to other SQL databases. An advantage of the ODBC interface is that it fully supports cross-partition queries, unlike the REST API. A disadvantage is that it does not support nested document fields; functions like <code>array_contains()</code> cannot be used, and attempts to reference arrays and objects may return incorrect results.
</p>


<h3>Value</h3>

<p><code>query_documents</code> returns the results of the query. Most of the time this will be a data frame, or list of data frames if <code>by_pkrange=TRUE</code>.
</p>


<h3>See Also</h3>

<p>cosmos_container, cosmos_document, list_partition_key_values, list_partition_key_ranges
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 

endp &lt;- cosmos_endpoint("https://myaccount.documents.azure.com:443/", key="mykey")

# importing the Star Wars data from dplyr
cont &lt;- endp %&gt;%
    get_cosmos_database(endp, "mydatabase") %&gt;%
    create_cosmos_container(db, "mycontainer", partition_key="sex")

bulk_import(cont, dplyr::starwars)

query_documents(cont, "select * from mycontainer")

# removing the Cosmos DB metadata cruft
query_documents(cont, "select * from mycontainer", metadata=FALSE)

# a simple filter
query_documents(cont, "select * from mycontainer c where c.gender = 'masculine'")

# run query for one partition key -- zero rows returned
query_documents(cont, "select * from mycontainer c where c.gender = 'masculine'",
    partition_key="female")

# aggregates will fail -- API does not fully support cross-partition queries
try(query_documents(cont, "select avg(c.height) avgheight from mycontainer c"))
# Error in process_cosmos_response.response(response, simplify = as_data_frame) :
#  Bad Request (HTTP 400). Failed to complete Cosmos DB operation. Message:
# ...

# run query separately by pkrange and combine the results manually
query_documents(
    cont,
    "select avg(c.height) avgheight, count(1) n from mycontainer c",
    by_pkrange=TRUE
)


## End(Not run)
</code></pre>


</div>