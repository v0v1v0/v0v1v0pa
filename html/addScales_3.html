<div class="container">

<table style="width: 100%;"><tr>
<td>addScales</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Add Scaling Information to Panels in Multi-Panel Trellis Plots
</h2>

<h3>Description</h3>

<p>Adds a midline and upper and lower horizontal and/or vertical scale lines
or shaded regions to all panels. Mostly useful when the
<code>relation = "free"</code> option is used in the
<code>scales</code> list to avoid loss of detail in plots from data that vary in
location and scale from panel to panel.
</p>


<h3>Usage</h3>

<pre><code class="language-R">   addScales(obj, ...)

## S3 method for class 'trellis'
addScales(obj,
         scaleline = list(h = TRUE, v = FALSE),
         legend = list(h = TRUE, v = TRUE),
         ndig.legend = c(h = 2, v = 2),
         legend.aes = list(),
         legend.loc = c("top","bottom","right","left"),
         panelFUN = panel.addScales,
         ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>obj</code></td>
<td>

<p>Object on which method dispatch is carried out. Currently only a <code>trellis</code>
method exists.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>scaleline</code></td>
<td>

<p>A two component list with component names "h" and "v". The
"h" component is for (h)orizontal scale lines/regions and "v" is
for(v)ertical. Each of these must be a single logical or numeric value
(and can be mixed in the list, of course). <code>TRUE</code> means: use a
calculated default; <code>FALSE</code> means: don't plot scale lines for
this component; and a numeric value means: use this value. The calculated
or user-supplied value is the distance between the midline and scale lines
= 1/2 the height/width of the shaded region.
A numeric value of 0 is interpreted as <code>FALSE</code> – don't draw.
However, see the <strong>Details</strong> section below for abbreviated versions that
are also accepted.
</p>
<p><b>Note:</b> Scale lines/regions are only meaningful for <code>"numeric"</code> data as defined
by <code>isTRUE(is.numeric())</code>. The corresponding <code>scaleline</code> component –
"h" for y-axis data and "v" for x-axis data – is silently set to <code>FALSE</code> for
anything else.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>legend</code></td>
<td>

<p>A two component list as in <code>scaleline</code> for logical values; or
non-logical values that must either be quoted UTF-8 character strings (which can
include special characters such as ±, which is unicode U + 00B1,
or °, unicode U + 00B0, math symbols, non-ascii language characters,
etc.); or R <code>language</code> objects. See the <strong>Legend Details</strong> section for
further details.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ndig.legend</code></td>
<td>

<p>Named or unnamed pair of integer arguments, or a single integer that will be
replicated. The names must be (and are assumed to be if unnamed) "h" and
"v" <em>in that order</em> and give the number of <em>significant</em>
digits to show in the default legend for the corresponding scale lines/region.
Non-integer values are rounded to integer, and values outside the range
of 0 to 15 digits are converted to 2.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>legend.aes</code></td>
<td>

<p>List of <em>aesthetics</em> of the legend text: <code>cex, font,
      fontface, col, etc.</code>. See <code>panel.text</code> for details.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>legend.loc</code></td>
<td>

<p>One of <code>"top", "bottom", "left",</code> or <code>"right"</code> specifying where the
legend will be placed <em>outside</em> the the trellised panels on the page.
See the <code>legend</code> section of the <code>xyplot</code> man page for
details, but note that <code>addScales</code> will turn the legend argument into a
list of the required form, so that part of the specification on the man page
can be ignored.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>panelFUN</code></td>
<td>

<p>The function used to add scaling details to the panels. Should use
standard trellis/grid functionality.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>Further arguments, controlling <em>aesthetics</em> of the lines, labels, and/or
fill regions such as color, line width, color palette, line type, etc., passed down to the
<code>panelFUN</code> function. See <code>panel.addScales</code> for details for the
default panel function.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>As a convenience, abbreviated versions of <code>scaleline</code> and
<code>legend</code> logical arguments can be used instead of the full versions
described above.The abbreviated versions will be translated into the full
versions for use by other functions such as <code>scaleline</code> and
<code>update.scaledTrellis</code>.
</p>
<p>Specifically, a single value of <code>TRUE</code> or <code>FALSE</code> is replicated to
both components of the argument. Thus <code>scaleline = FALSE</code> aborts the
function, since it says not to add scales in either direction. <code>
   legend = FALSE</code> is fine, because it specifies only that legends be omitted.
See the <b>Legend Specification Details</b> section below for why this might be useful.
</p>
<p>If an unnamed list with two components (of the correct form) are given, they are
assumed to be in the order <code>c("h","v")</code>. If a single named component with
name "h" or "v" is given, the missing component is assumed
to be <code>FALSE</code>. Thus, <code>list(v = TRUE), list(FALSE, TRUE)</code>, and
<code>list(h = FALSE, v = TRUE)</code> are all equivalent. A list with a single
unnamed component raises an error.
</p>
<p>The default <code>scaleline</code> calculation assures that all lines/regions fall within the
axis limits of all panels. A (typically user-supplied) <code>scaleline</code>
that fails this criterion will raise a warning and result in some
panels with missing scale lines when <code>scaleType = "line"</code>.
</p>


<h3>Value</h3>

<p>An object of class <code>c("scaledTrellis","trellis")</code> if successful.
Because it inherits from class <code>"trellis"</code>, it can be saved
and/or (automatically) plotted as usual.<br></p>
<p><code>NULL</code> invisibly if an error occurs.
</p>
<p>The <code>scaledTrellis</code> object is the original <code>trellis</code> object list
with its <code>panel</code> and <code>legend</code> components modified to add the
scaling information. A new <code>addScales</code> component is also added
that is itself a list with (at least) two components named "orig" and "args".
The first of these contains the original
<code>panel</code> and <code>legend</code> components of <code>obj</code>. The second
contains either the names and values of the arguments in the call or the computed
values of those arguments. The most important of these is the <code>scaleline</code>
value, which can be extracted using the <code>scaleline</code> function by users
who wish to construct their own scale line legends.The remaining values are used
by the update method for <code>scaledTrellis</code> objects.
</p>


<h3>Legend Specification Details</h3>

<p>The default legend is meant to be simple but serviceable. If there are scale lines
in both directions, it will space them horizontally for <code>"top"</code> and <code>
   "bottom"</code> locations and vertically for <code>"right"</code> and <code>"left"</code> to
minimize the space they occupy.
</p>
<p>A user-supplied legend component can be given in two forms: either as a (quoted)
UTF-8 character string, like this: "Scale lines are at ±10° ";
or as a so-called <code>language</code> object. The latter allows the legend to use the
(shortened to the <code>ndig.legend</code> number of digits) <code>scaleline</code> value.
The former does not.
</p>
<p>A detailed discussion of <code>language</code> objects is beyond the scope of this Help
page, but a simple example provides a template that should usually suffice. Suppose,
instead of the default, the desired legend is:
</p>
<p><code style="white-space: pre;">⁠     Scale lines are at⁠</code> ± <code style="white-space: pre;">⁠xxx⁠</code>°,
</p>
<p>where the <code style="white-space: pre;">⁠scaleline⁠</code> value computed by <code>addScales</code> is to be substituted
for the xxx. If xxx were available in the environment of the call
(the <code style="white-space: pre;">⁠addScales⁠</code> invocation), then one could use something like
(as in the previous paragraph):
</p>
<p><code style="white-space: pre;">⁠     paste0("Scale lines are at⁠</code> ±
<code style="white-space: pre;">⁠",xxx,"⁠</code> ° "<code style="white-space: pre;">⁠)⁠</code>
</p>
<p>as the <code>legend</code> argument. But xxx is not known, because <code>addScales</code>
hasn't calculated it yet. So instead, wrap the paste0 call by the
<code>quote</code> function like this:
</p>
<p><code style="white-space: pre;">⁠     quote(paste0("Scale lines are at⁠</code> ±
<code style="white-space: pre;">⁠",sl,"⁠</code> ° "<code style="white-space: pre;">⁠))⁠</code>
</p>
<p>‘sl’ (unquoted) <em>must</em> be used to replace the not-yet-known <code>
   scaleline</code> value. The <code>quote</code> function will pass the whole unevaluated
<code>paste0</code> expression into <code>addScales</code>
where the <code>scaleline</code> value will be calculated and substituted for
<code>sl</code> and the whole expression then evaluated.
Of course, any R expression instead of <code>paste0...</code> can
be used as long as <code>sl</code> is substituted wherever the actual <code>scaleline</code>
value is wanted.
</p>
<p>Another, perhaps slightly clumsier, way to do this – but which generalizes to
arbitrary <code>scaleline</code> displays as text or graphical objects (so-called
<em>grobs</em>) of any kind – is simply to run
<code>addScales</code> with <code>legend = FALSE</code> and extract the
<code>scaleline</code> value(s) from the resulting object with the <code>scaleline()</code>
function. The value(s) can then be used in any construction the user wishes to create.
</p>


<h3>Author(s)</h3>

<p>Bert Gunter <a href="mailto:bgunter.4567@gmail.com">bgunter.4567@gmail.com</a>
</p>


<h3>See Also</h3>

<p><code>xyplot</code>,
<code>panel.refline</code>,
<code>panel.text</code>,
<code>scaleline</code>,
<code>panel.addScales</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">###### Artificial example to show why addScales() might be useful and
###### how it works
##

###### Create a data set whose panels have different
###### centers and scales for y
x &lt;- rep(0:10, 4)

scaling &lt;- rep(c(1, 2, 5, 10), e = 11)

y &lt;- sin(pi*x/10)*scaling + scaling ## add some structure

f &lt;- factor(rep(LETTERS[1:4], e = 11))

## Now add noise proportional to data mean (= constant CV)
set.seed(91834)

y &lt;- y + rnorm(44,sd = scaling/3)

## Plot this with the default "same" scaling and a loess curve

xyplot(y ~ x| f, layout = c(4,1), col = "darkblue",
        scales = list(alternating = 1, tck = c(1,0)),
        panel = function(...){
           panel.points(...)
           panel.loess(..., span = .6, col.line = "blue")
        })

##
## Because of the different scaling, it's somewhat difficult to
## see the common panel data behavior. With relation = "free", it
## becomes clearer:
##
trellis.par.set(plot.symbol = list(col = "darkblue"),
               plot.line = list(col = "darkblue"))

xyplot(y ~ x| f, layout = c(4,1),
       scales = list(alternating = 1, tck = c(1,0),
                     y = list(relation = "free")),
       panel = function(...){
          panel.points(...)
          panel.loess(..., span = .6, col.line = "blue")
       })

##
##  Unfortunately, the y-scales take up a lot of space and are
##  difficult to read. With more panels, they would completely
##  mess things up. To avoid this, don't draw them and use addScales
##  to layer visual scaling onto the panels.
##
freeplot &lt;- xyplot(y ~ x| f, layout = c(4,1),
          scales = list(alternating = 1, tck = c(1,0),
                        y = list(relation = "free", draw = FALSE)),
          panel = function(...){
             panel.points(...)
             panel.loess(..., span = .6, col.line = "blue")
          })

addScales(freeplot) ## using defaults

##
## The labeled midline allows location comparison among the panels.
## The fixed distance from the dashed scale lines to the midline are given
## by the legend at top. This allows scaling among the panels to be
## compared, because the more y varies within a panel, the closer together
## these fixed scale lines become.
##
## NOTE:
## The addScales object inherits from class "trellis", so can be
## saved and plotted in the same way as 'freeplot' was. That is, the
## following also works:
##
 enhanced &lt;- addScales(freeplot)
 enhanced

## Further panel options, which we use the update() method to change,
## allow for color coded scale regions and midlines:
##
#### Warning: Nothing may display if your graphics device does not support
## alpha transparency

 update(enhanced, scaleType = "region", colCode = "r")

##
## cleanup
rm(scaling, x, y, f, freeplot, enhanced)
##
########  Some real examples   #############
############################################

## Historical daily temperatures for Chicago, New York, and San Francisco.
data(CHITemps, NYCTemps, SFTemps)

preprocess.temps &lt;- function(d){
      meanTemp &lt;- with(d, (TMAX + TMIN)/2)
      Month &lt;- months(as.Date(d$DATE))
      z&lt;- aggregate(meanTemp, list(
         Month = factor(Month, levels = unique(Month)),
         Year = as.numeric(substring(d$DATE,1,4))
      ), FUN = mean)
      names(z)[3] &lt;- "meanTemp"
      z
}

## Create a list containing the preprocessed data for all 3 cities
plotdat &lt;- lapply(
   list(CHI = CHITemps, NYC = NYCTemps, SF = SFTemps),
   preprocess.temps)

## Consider NYC. Because of monthly temperature variation, monthly temperature
## histories are mostly whitespace with the default relation = "same".
## Note also the use of the prepanel.trim function with defaults to remove
## extreme y values.
##
## Consider New York City
nyctemps &lt;-
   xyplot(meanTemp ~ Year|Month, type = "l", layout = c(3,4),
          data = plotdat[[2]],
          as.table = TRUE,
          between = list(x=1, y=0),
          ## reduce strip size
          par.strip.text = list(lines = .8, cex = .7),
          ## remove blank space for top axis
          par.settings = list(layout.heights = list(axis.top = 0)),
          prepanel = prepanel.trim, ## to remove possible extreme values
          panel = function(...){
             panel.grid(v = -1, h = 0, col = "gray70")
             panel.xyplot(...)
             panel.loess(..., span = .5, col = "darkred",
             lwd = 1.5)
          },
          scales = list(axs = "i", alternating = 1, tck = c(1,0)),
          xlab = "Year",
          ylab = "Average Temperature (\u00B0F)",
          main = "Mean Monthly Historical Temperatures in NYC"
   )

nyctemps

## Now try it with y-scale = "free' and addScales
##
nyctemps &lt;- update(nyctemps,
   scales = list(axs = "i", alternating = 1,
   tck = c(1,0),y = list(relation = "free", draw = FALSE)))

addScales(nyctemps)

## The historical temperature trend as the city
## built up and modernized (more concrete and asphalt,people,
## heat sources, etc.) is clearer and quantified by the
## legend and scale lines; and the scale lines also show
## that winter temperatures are clearly more variable than summer.
## This was almost undetectable in the previous plot.

## The same plot using region shading instead of scale lines.
## Warning: May not display if your graphics device does not support
## alpha transparency

addScales(nyctemps, scaleType = "region")

## ... and using color coding for midlines and regions to better visually
## distinguish their values...
##
addScales(nyctemps, scaleType = "region", colCode = "r")

## You can repeat the exercise with the other two cities if you like.
## cleanup
rm(nyctemps, preprocess.temps, plotdat)

#######  Historical Crime Data #####

data(USAcrime)

## We explore the relationship beween property and violent crime over time.
## Point transparency via the 'alpha' setting is used to code year
## and the violent vs. property crime relationship is trellised by state
## for a selection of states.
##
## First with scales = "same", the default..

state.smpl &lt;- c("CA","TX","GA","CO","VA","FL","NY","OH","MO","UT","MA","TN")

wh &lt;- USAcrime$State %in% state.smpl

pcols &lt;- hcl.colors(55, rev = TRUE)

crm &lt;-xyplot(allViolent ~ allProperty|State, data = USAcrime[wh,],
             subscripts = TRUE, as.table = TRUE,
             layout = c(4,3), type = c("p", "g"),
             cex= .75,  pch = 19,
             col = pcols[USAcrime[wh,'Year'] -1959],
             par.strip.text = list(lines = .8, cex = .7),
             between = list(x = 1),
             scales = list(axs="i",alternating =1, tck = c(1,0)),
             xlab = "Property Crime Rate (incidents/100,000 population)",
             ylab = "Violent Crime Rate (incidents/100,000 population)",
             main = paste0("Violent vs. Property Crime Rates from 1960-2014 For 12 States"),
             sub = "Point Darkness Codes Years: Darker = Later Years",
             panel = function(subscripts,col,...)
                panel.xyplot(col = col[subscripts],...)
)
crm
## remove the grid and update with
## "free" scales and no axes for both x and y
crm2 &lt;- update(crm, type = "p",
            scales = list(axs="i", relation = "free", draw = FALSE))

## Add scales for both x and y and color code midlines
addScales(crm2, scaleline = TRUE, colCode = "m")

## Some features to note:
##  1. As one might expect, violent and property crime rates are
##   correlated.
##
##  2. Crime rates first increased, peaked, and then decreased over time.
##
##  3. For most states there appears to be a kind of 'hysteresis':
##  the trajectory of the crime decrease is shifted up (higher violent
##  crime rate for the same property rate) from when it increased.
##  This could have been due to a change in reporting procedures,
##  over time, for example.
##
##  4. The midline colors and labels show that NY has the highest
##  violent crime rate, but a modest property crime rate: Tennessee
##  has a middling violent crime rate but the lowest (with VA) property
##  crime rate.
##
##  cleanup
   rm( state.smpl, wh, pcols, crm, crm2)
</code></pre>


</div>