<div class="container">

<table style="width: 100%;"><tr>
<td>derive_var_extreme_flag</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Add a Variable Flagging the First or Last Observation Within Each By Group</h2>

<h3>Description</h3>

<p>Add a variable flagging the first or last observation within each by group
</p>


<h3>Usage</h3>

<pre><code class="language-R">derive_var_extreme_flag(
  dataset,
  by_vars,
  order,
  new_var,
  mode,
  true_value = "Y",
  false_value = NA_character_,
  flag_all = FALSE,
  check_type = "warning"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>dataset</code></td>
<td>
<p>Input dataset
</p>
<p>The variables specified by the <code>by_vars</code> argument are expected to be in the dataset.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>by_vars</code></td>
<td>
<p>Grouping variables
</p>
<p><em>Permitted Values</em>: list of variables created by <code>exprs()</code>
e.g. <code>exprs(USUBJID, VISIT)</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>order</code></td>
<td>
<p>Sort order
</p>
<p>The first or last observation is determined with respect to the specified
order.
</p>
<p>For handling of <code>NA</code>s in sorting variables see <a href="../articles/generic.html#sort_order">Sort Order</a>.
</p>
<p>Permitted Values: list of variables or functions of variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>new_var</code></td>
<td>
<p>Variable to add
</p>
<p>The specified variable is added to the output dataset. It is set to the value
set in <code>true_value</code> for the first or last observation (depending on the mode) of each by group.
</p>
<p>Permitted Values: list of name-value pairs</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mode</code></td>
<td>
<p>Flag mode
</p>
<p>Determines of the first or last observation is flagged.
</p>
<p>Permitted Values: <code>"first"</code>, <code>"last"</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>true_value</code></td>
<td>
<p>True value
</p>
<p>The value for the specified variable <code>new_var</code>, applicable to
the first or last observation (depending on the mode) of each by group.
</p>
<p>Permitted Values: An atomic scalar</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>false_value</code></td>
<td>
<p>False value
</p>
<p>The value for the specified variable <code>new_var</code>, NOT applicable to
the first or last observation (depending on the mode) of each by group.
</p>
<p>Permitted Values: An atomic scalar</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>flag_all</code></td>
<td>
<p>Flag setting
</p>
<p>A logical value where if set to <code>TRUE</code>, all records are flagged
and no error or warning is issued if the first or last record is not unique.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>check_type</code></td>
<td>
<p>Check uniqueness?
</p>
<p>If <code>"warning"</code> or <code>"error"</code> is specified, the specified message is issued
if the observations of the input dataset are not unique with respect to the
by variables and the order.
</p>
<p>Default: <code>"warning"</code>
</p>
<p>Permitted Values: <code>"none"</code>, <code>"warning"</code>, <code>"error"</code></p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>For each group (with respect to the variables specified for the
<code>by_vars</code> parameter), <code>new_var</code> is set to <code>"Y"</code> for the first or last observation
(with respect to the order specified for the <code>order</code> parameter and the flag mode
specified for the <code>mode</code> parameter). In the case where the user wants to flag multiple records
of a grouping, for example records that all happen on the same visit and time, the argument
<code>flag_all</code> can be set to <code>TRUE</code>.
Otherwise, <code>new_var</code> is set to <code>NA</code>. Thus, the direction of "worst" is considered fixed for
all parameters in the dataset depending on the <code>order</code> and the <code>mode</code>, i.e. for every
parameter the first or last record will be flagged across the whole dataset.
</p>


<h3>Value</h3>

<p>The input dataset with the new flag variable added
</p>


<h3>See Also</h3>

<p>General Derivation Functions for all ADaMs that returns variable appended to dataset:
<code>derive_var_joined_exist_flag()</code>,
<code>derive_var_merged_ef_msrc()</code>,
<code>derive_var_merged_exist_flag()</code>,
<code>derive_var_merged_summary()</code>,
<code>derive_var_obs_number()</code>,
<code>derive_var_relative_flag()</code>,
<code>derive_vars_computed()</code>,
<code>derive_vars_joined()</code>,
<code>derive_vars_merged()</code>,
<code>derive_vars_merged_lookup()</code>,
<code>derive_vars_transposed()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(tibble)
library(dplyr, warn.conflicts = FALSE)
example_vs &lt;- tribble(
  ~USUBJID, ~VSTESTCD,      ~VISIT, ~VISITNUM, ~VSTPTNUM, ~VSSTRESN,
  "1001",     "DIABP", "SCREENING",         1,        10,        64,
  "1001",     "DIABP", "SCREENING",         1,        11,        66,
  "1001",     "DIABP",  "BASELINE",         2,       100,        68,
  "1001",     "DIABP",  "BASELINE",         2,       101,        68,
  "1001",     "DIABP",    "WEEK 2",         3,       200,        72,
  "1001",     "DIABP",    "WEEK 2",         3,       201,        71,
  "1001",     "DIABP",    "WEEK 4",         4,       300,        70,
  "1001",     "DIABP",    "WEEK 4",         4,       301,        70
)

# Flag last value for each patient, test, and visit, baseline observations are ignored
example_vs %&gt;%
  restrict_derivation(
    derivation = derive_var_extreme_flag,
    args = params(
      by_vars = exprs(USUBJID, VSTESTCD, VISIT),
      order = exprs(VSTPTNUM),
      new_var = LASTFL,
      mode = "last"
    ),
    filter = VISIT != "BASELINE"
  ) %&gt;%
  arrange(USUBJID, VSTESTCD, VISITNUM, VSTPTNUM) %&gt;%
  select(USUBJID, VSTESTCD, VISIT, VSTPTNUM, VSSTRESN, LASTFL)

# Baseline (ABLFL) examples:

input &lt;- tribble(
  ~STUDYID, ~USUBJID,  ~PARAMCD,     ~AVISIT,                  ~ADT, ~AVAL,    ~DTYPE,
  "TEST01",  "PAT01", "PARAM01",  "BASELINE", as.Date("2021-04-27"),  15.0,        NA,
  "TEST01",  "PAT01", "PARAM01",  "BASELINE", as.Date("2021-04-25"),  14.0,        NA,
  "TEST01",  "PAT01", "PARAM01",  "BASELINE", as.Date("2021-04-23"),  15.0, "AVERAGE",
  "TEST01",  "PAT01", "PARAM01",    "WEEK 1", as.Date("2021-04-27"),  10.0, "AVERAGE",
  "TEST01",  "PAT01", "PARAM01",    "WEEK 2", as.Date("2021-04-30"),  12.0,        NA,
  "TEST01",  "PAT02", "PARAM01", "SCREENING", as.Date("2021-04-27"),  15.0, "AVERAGE",
  "TEST01",  "PAT02", "PARAM01",  "BASELINE", as.Date("2021-04-25"),  14.0, "AVERAGE",
  "TEST01",  "PAT02", "PARAM01",  "BASELINE", as.Date("2021-04-23"),  15.0, "AVERAGE",
  "TEST01",  "PAT02", "PARAM01",    "WEEK 1", as.Date("2021-04-27"),  10.0, "AVERAGE",
  "TEST01",  "PAT02", "PARAM01",    "WEEK 2", as.Date("2021-04-30"),  12.0, "AVERAGE",
  "TEST01",  "PAT01", "PARAM02", "SCREENING", as.Date("2021-04-27"),  15.0, "AVERAGE",
  "TEST01",  "PAT01", "PARAM02", "SCREENING", as.Date("2021-04-25"),  14.0, "AVERAGE",
  "TEST01",  "PAT01", "PARAM02", "SCREENING", as.Date("2021-04-23"),  15.0,        NA,
  "TEST01",  "PAT01", "PARAM02",  "BASELINE", as.Date("2021-04-27"),  10.0, "AVERAGE",
  "TEST01",  "PAT01", "PARAM02",    "WEEK 2", as.Date("2021-04-30"),  12.0,        NA,
  "TEST01",  "PAT02", "PARAM02", "SCREENING", as.Date("2021-04-27"),  15.0,        NA,
  "TEST01",  "PAT02", "PARAM02",  "BASELINE", as.Date("2021-04-25"),  14.0,        NA,
  "TEST01",  "PAT02", "PARAM02",    "WEEK 1", as.Date("2021-04-23"),  15.0,        NA,
  "TEST01",  "PAT02", "PARAM02",    "WEEK 1", as.Date("2021-04-27"),  10.0,        NA,
  "TEST01",  "PAT02", "PARAM02",  "BASELINE", as.Date("2021-04-30"),  12.0,        NA
)

# Last observation
restrict_derivation(
  input,
  derivation = derive_var_extreme_flag,
  args = params(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(ADT),
    new_var = ABLFL,
    mode = "last"
  ),
  filter = AVISIT == "BASELINE"
)

# Worst observation - Direction = High
restrict_derivation(
  input,
  derivation = derive_var_extreme_flag,
  args = params(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(AVAL, ADT),
    new_var = ABLFL,
    mode = "last"
  ),
  filter = AVISIT == "BASELINE"
)

# Worst observation - Direction = Lo
restrict_derivation(
  input,
  derivation = derive_var_extreme_flag,
  args = params(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(desc(AVAL), ADT),
    new_var = ABLFL,
    mode = "last"
  ),
  filter = AVISIT == "BASELINE"
)

# Average observation
restrict_derivation(
  input,
  derivation = derive_var_extreme_flag,
  args = params(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(ADT, desc(AVAL)),
    new_var = ABLFL,
    mode = "last"
  ),
  filter = AVISIT == "BASELINE" &amp; DTYPE == "AVERAGE"
)

# OCCURDS Examples
example_ae &lt;- tribble(
  ~USUBJID,         ~AEBODSYS,    ~AEDECOD,   ~AESEV, ~AESTDY, ~AESEQ,
  "1015", "GENERAL DISORDERS",  "ERYTHEMA",   "MILD",       2,      1,
  "1015", "GENERAL DISORDERS",  "PRURITUS",   "MILD",       2,      2,
  "1015",      "GI DISORDERS", "DIARRHOEA",   "MILD",       8,      3,
  "1023", "CARDIAC DISORDERS",  "AV BLOCK",   "MILD",      22,      4,
  "1023",    "SKIN DISORDERS",  "ERYTHEMA",   "MILD",       3,      1,
  "1023",    "SKIN DISORDERS",  "ERYTHEMA", "SEVERE",       5,      2,
  "1023",    "SKIN DISORDERS",  "ERYTHEMA",   "MILD",       8,      3
)

# Most severe AE first occurrence per patient
example_ae %&gt;%
  mutate(
    TEMP_AESEVN =
      as.integer(factor(AESEV, levels = c("SEVERE", "MODERATE", "MILD")))
  ) %&gt;%
  derive_var_extreme_flag(
    new_var = AOCCIFL,
    by_vars = exprs(USUBJID),
    order = exprs(TEMP_AESEVN, AESTDY, AESEQ),
    mode = "first"
  ) %&gt;%
  arrange(USUBJID, AESTDY, AESEQ) %&gt;%
  select(USUBJID, AEDECOD, AESEV, AESTDY, AESEQ, AOCCIFL)

# Most severe AE first occurrence per patient (flag all cases)
example_ae %&gt;%
  mutate(
    TEMP_AESEVN =
      as.integer(factor(AESEV, levels = c("SEVERE", "MODERATE", "MILD")))
  ) %&gt;%
  derive_var_extreme_flag(
    new_var = AOCCIFL,
    by_vars = exprs(USUBJID),
    order = exprs(TEMP_AESEVN, AESTDY),
    mode = "first",
    flag_all = TRUE
  ) %&gt;%
  arrange(USUBJID, AESTDY) %&gt;%
  select(USUBJID, AEDECOD, AESEV, AESTDY, AOCCIFL)

# Most severe AE first occurrence per patient per body system
example_ae %&gt;%
  mutate(
    TEMP_AESEVN =
      as.integer(factor(AESEV, levels = c("SEVERE", "MODERATE", "MILD")))
  ) %&gt;%
  derive_var_extreme_flag(
    new_var = AOCCSIFL,
    by_vars = exprs(USUBJID, AEBODSYS),
    order = exprs(TEMP_AESEVN, AESTDY, AESEQ),
    mode = "first"
  ) %&gt;%
  arrange(USUBJID, AESTDY, AESEQ) %&gt;%
  select(USUBJID, AEBODSYS, AESEV, AESTDY, AOCCSIFL)
</code></pre>


</div>