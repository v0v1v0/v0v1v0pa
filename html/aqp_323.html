<div class="container">

<table style="width: 100%;"><tr>
<td>sp3</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Soil Profile Data Example 3</h2>

<h3>Description</h3>

<p>Soil samples from 10 soil profiles, taken from the Sierra Foothill Region of
California.
</p>


<h3>Format</h3>

<p>A data frame with 46 observations on the following 15 variables.
</p>
 <dl>
<dt>id</dt>
<dd>
<p>soil id</p>
</dd> <dt>top</dt>
<dd>
<p>horizon upper
boundary (cm)</p>
</dd> <dt>bottom</dt>
<dd>
<p>horizon lower boundary (cm)</p>
</dd>
<dt>clay</dt>
<dd>
<p>clay content</p>
</dd> <dt>cec</dt>
<dd>
<p>CEC by amonium acetate
at pH 7</p>
</dd> <dt>ph</dt>
<dd>
<p>pH in 1:1 water-soil mixture</p>
</dd>
<dt>tc</dt>
<dd>
<p>total carbon percent</p>
</dd> <dt>hue</dt>
<dd>
<p>Munsell hue
(dry)</p>
</dd> <dt>value</dt>
<dd>
<p>Munsell value (dry)</p>
</dd>
<dt>chroma</dt>
<dd>
<p>Munsell chroma (dry)</p>
</dd> <dt>mid</dt>
<dd>
<p>horizon
midpoint (cm)</p>
</dd> <dt>ln_tc</dt>
<dd>
<p>natural log of total carbon percent</p>
</dd>
<dt>L</dt>
<dd>
<p>color: l-coordinate, CIE-LAB colorspace (dry)</p>
</dd>
<dt>A</dt>
<dd>
<p>color: a-coordinate, CIE-LAB colorspace (dry)</p>
</dd>
<dt>B</dt>
<dd>
<p>color: b-coordinate, CIE-LAB colorspace (dry)</p>
</dd>
<dt>name</dt>
<dd>
<p>horizon name</p>
</dd> <dt>soil_color</dt>
<dd>
<p>horizon color</p>
</dd> </dl>
<h3>Details</h3>

<p>These data were collected to support research funded by the Kearney
Foundation of Soil Science.
</p>


<h3>References</h3>

<p><a href="https://casoilresource.lawr.ucdavis.edu/">https://casoilresource.lawr.ucdavis.edu/</a>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
## this example investigates the concept of a "median profile"

# required packages
if (require(ape) &amp; require(cluster)) {
  data(sp3)

  # generate a RGB version of soil colors
  # and convert to HSV for aggregation
  sp3$h &lt;- NA
  sp3$s &lt;- NA
  sp3$v &lt;- NA
  sp3.rgb &lt;- with(sp3, munsell2rgb(hue, value, chroma, return_triplets = TRUE))

  sp3[, c('h', 's', 'v')] &lt;- t(with(sp3.rgb, rgb2hsv(r, g, b, maxColorValue = 1)))

  # promote to SoilProfileCollection
  depths(sp3) &lt;- id ~ top + bottom

  # aggregate across entire collection
  a &lt;- slab(sp3, fm = ~ clay + cec + ph + h + s + v, slab.structure = 10)

  # check
  str(a)

  # convert back to wide format
  library(data.table)

  a.wide.q25 &lt;- dcast(as.data.table(a), top + bottom ~ variable, value.var = c('p.q25'))
  a.wide.q50 &lt;- dcast(as.data.table(a), top + bottom ~ variable, value.var = c('p.q50'))
  a.wide.q75 &lt;- dcast(as.data.table(a), top + bottom ~ variable, value.var = c('p.q75'))

  # add a new id for the 25th, 50th, and 75th percentile pedons
  a.wide.q25$id &lt;- 'Q25'
  a.wide.q50$id &lt;- 'Q50'
  a.wide.q75$id &lt;- 'Q75'

  # combine original data with "mean profile"
  vars &lt;- c('top', 'bottom', 'id', 'clay', 'cec', 'ph', 'h', 's', 'v')
  # make data.frame version of sp3
  sp3.df &lt;- as(sp3, 'data.frame')

  sp3.grouped &lt;- as.data.frame(rbind(as.data.table(horizons(sp3))[, .SD, .SDcol = vars], 
                                     a.wide.q25[, .SD, .SDcol = vars],
                                     a.wide.q50[, .SD, .SDcol = vars], 
                                     a.wide.q75[, .SD, .SDcol = vars]))
                                     
  # re-constitute the soil color from HSV triplets
  # convert HSV back to standard R colors
  sp3.grouped$soil_color &lt;- with(sp3.grouped, hsv(h, s, v))

  # give each horizon a name
  sp3.grouped$name &lt;- paste(
    round(sp3.grouped$clay),
    '/' ,
    round(sp3.grouped$cec),
    '/',
    round(sp3.grouped$ph, 1)
  )


# first promote to SoilProfileCollection
depths(sp3.grouped) &lt;- id ~ top + bottom

plot(sp3.grouped)

## perform comparison, and convert to phylo class object
## D is rescaled to [0,]
d &lt;- NCSP(
  sp3.grouped,
  vars = c('clay', 'cec', 'ph'),
  maxDepth = 100,
  k = 0.01
)

h &lt;- agnes(d, method = 'ward')
p &lt;- ladderize(as.phylo(as.hclust(h)))

# look at distance plot-- just the median profile
plot_distance_graph(d, 12)

# similarity relative to median profile (profile #12)
round(1 - (as.matrix(d)[12, ] / max(as.matrix(d)[12, ])), 2)

## make dendrogram + soil profiles

# setup plot: note that D has a scale of [0,1]
par(mar = c(1, 1, 1, 1))
p.plot &lt;- plot(p,
               cex = 0.8,
               label.offset = 3,
               direction = 'up',
               y.lim = c(200, 0),
               x.lim = c(1.25, length(sp3.grouped) + 1),
               show.tip.label = FALSE)

# get the last plot geometry
lastPP &lt;- get("last_plot.phylo", envir = .PlotPhyloEnv)

# the original labels, and new (indexed) order of pedons in dendrogram
d.labels &lt;- attr(d, 'Labels')

new_order &lt;- sapply(1:lastPP$Ntip,
                    function(i)
                      which(as.integer(lastPP$xx[1:lastPP$Ntip]) == i))

# plot the profiles, in the ordering defined by the dendrogram
# with a couple fudge factors to make them fit
plotSPC(
  sp3.grouped,
  color = "soil_color",
  plot.order = new_order,
  y.offset = max(lastPP$yy) + 10,
  width = 0.1,
  cex.names = 0.5,
  add = TRUE
)
}
</code></pre>


</div>