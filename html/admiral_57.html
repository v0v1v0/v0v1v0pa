<div class="container">

<table style="width: 100%;"><tr>
<td>create_single_dose_dataset</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Create dataset of single doses</h2>

<h3>Description</h3>

<p>Derives dataset of single dose from aggregate dose information. This may be
necessary when e.g. calculating last dose before an adverse event in <code>ADAE</code>
or deriving a total dose parameter in <code>ADEX</code> when <code>EXDOSFRQ != ONCE</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">create_single_dose_dataset(
  dataset,
  dose_freq = EXDOSFRQ,
  start_date = ASTDT,
  start_datetime = NULL,
  end_date = AENDT,
  end_datetime = NULL,
  lookup_table = dose_freq_lookup,
  lookup_column = CDISC_VALUE,
  nominal_time = NULL,
  keep_source_vars = expr_c(exprs(USUBJID), dose_freq, start_date, start_datetime,
    end_date, end_datetime)
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>dataset</code></td>
<td>
<p>Input dataset
</p>
<p>The variables specified by the <code>dose_freq</code>, <code>start_date</code>, and <code>end_date</code> arguments are expected to be in the dataset.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dose_freq</code></td>
<td>
<p>The dose frequency
</p>
<p>The aggregate dosing frequency used for multiple doses in a row.
</p>
<p>Permitted Values: defined by lookup table.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>start_date</code></td>
<td>
<p>The start date
</p>
<p>A date object is expected. This object cannot contain <code>NA</code> values.
</p>
<p>Refer to <code>derive_vars_dt()</code> to impute and derive a date from a date
character vector to a date object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>start_datetime</code></td>
<td>
<p>The start date-time
</p>
<p>A date-time object is expected. This object cannot contain <code>NA</code> values.
</p>
<p>Refer to <code>derive_vars_dtm()</code> to impute and derive a date-time from a date
character vector to a date object.
</p>
<p>If the input dataset contains frequencies which refer to <code>DOSE_WINDOW</code>
equals <code>"HOUR"</code> or <code>"MINUTE"</code>, the parameter must be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>end_date</code></td>
<td>
<p>The end date
</p>
<p>A date or date-time object is expected. This object cannot contain <code>NA</code> values.
</p>
<p>Refer to <code>derive_vars_dt()</code> to impute and derive a date from a date
character vector to a date object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>end_datetime</code></td>
<td>
<p>The end date-time
</p>
<p>A date-time object is expected. This object cannot contain <code>NA</code> values.
</p>
<p>Refer to <code>derive_vars_dtm()</code> to impute and derive a date-time from a date
character vector to a date object.
</p>
<p>If the input dataset contains frequencies which refer to <code>DOSE_WINDOW</code>
equals <code>"HOUR"</code> or <code>"MINUTE"</code>, the parameter must be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lookup_table</code></td>
<td>
<p>The dose frequency value lookup table
</p>
<p>The table used to look up <code>dose_freq</code> values and determine the appropriate
multiplier to be used for row generation. If a lookup table other than the
default is used, it must have columns <code>DOSE_WINDOW</code>, <code>DOSE_COUNT</code>, and
<code>CONVERSION_FACTOR</code>. The default table <code>dose_freq_lookup</code> is described in
detail here.
</p>
<p>Permitted Values for <code>DOSE_WINDOW</code>: <code>"MINUTE"</code>, <code>"HOUR"</code>, <code>"DAY"</code>,
<code>"WEEK"</code>, <code>"MONTH"</code>, <code>"YEAR"</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lookup_column</code></td>
<td>
<p>The dose frequency value column in the lookup table
</p>
<p>The column of <code>lookup_table</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nominal_time</code></td>
<td>
<p>The nominal relative time from first dose (<code>NFRLT</code>)
</p>
<p>Used for PK analysis, this will be in hours and should be 0 for
the first dose.  It can be derived as <code>(VISITDY - 1) * 24</code> for example.
This will be expanded as the single dose dataset is created.  For example
an <code>EXDOFRQ</code> of <code>"QD"</code> will result in the nominal_time being incremented by
24 hours for each expanded record.
</p>
<p>The value can be NULL if not needed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>keep_source_vars</code></td>
<td>
<p>List of variables to be retained from source dataset
</p>
<p>This parameter can be specified if additional information is required in
the output dataset. For example <code>EXTRT</code> for studies with more than one
drug.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Each aggregate dose row is split into multiple rows which each
represent a single dose.The number of completed dose periods between
<code>start_date</code> or <code>start_datetime</code> and <code>end_date</code> or <code>end_datetime</code> is
calculated with <code>compute_duration</code> and multiplied by <code>DOSE_COUNT</code>.
For <code>DOSE_WINDOW</code> values of <code>"WEEK"</code>, <code>"MONTH"</code>, and <code>"YEAR"</code>,
<code>CONVERSION_FACTOR</code> is used to convert into days the time object
to be added to <code>start_date</code>.
</p>
<p>Observations with dose frequency <code>"ONCE"</code> are copied to the output dataset
unchanged.
</p>


<h3>Value</h3>

<p>The input dataset with a single dose per row.
</p>


<h3>See Also</h3>

<p>Creating auxiliary datasets: 
<code>consolidate_metadata()</code>,
<code>create_period_dataset()</code>,
<code>create_query_data()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Example with default lookup

library(lubridate)
library(stringr)
library(tibble)
library(dplyr)

data &lt;- tribble(
  ~USUBJID, ~EXDOSFRQ, ~ASTDT, ~ASTDTM, ~AENDT, ~AENDTM,
  "P01", "Q2D", ymd("2021-01-01"), ymd_hms("2021-01-01 10:30:00"),
  ymd("2021-01-07"), ymd_hms("2021-01-07 11:30:00"),
  "P01", "Q3D", ymd("2021-01-08"), ymd_hms("2021-01-08 12:00:00"),
  ymd("2021-01-14"), ymd_hms("2021-01-14 14:00:00"),
  "P01", "EVERY 2 WEEKS", ymd("2021-01-15"), ymd_hms("2021-01-15 09:57:00"),
  ymd("2021-01-29"), ymd_hms("2021-01-29 10:57:00")
)

create_single_dose_dataset(data)

# Example with custom lookup

custom_lookup &lt;- tribble(
  ~Value,   ~DOSE_COUNT, ~DOSE_WINDOW, ~CONVERSION_FACTOR,
  "Q30MIN", (1 / 30),    "MINUTE",                      1,
  "Q90MIN", (1 / 90),    "MINUTE",                      1
)

data &lt;- tribble(
  ~USUBJID, ~EXDOSFRQ, ~ASTDT, ~ASTDTM, ~AENDT, ~AENDTM,
  "P01", "Q30MIN", ymd("2021-01-01"), ymd_hms("2021-01-01T06:00:00"),
  ymd("2021-01-01"), ymd_hms("2021-01-01T07:00:00"),
  "P02", "Q90MIN", ymd("2021-01-01"), ymd_hms("2021-01-01T06:00:00"),
  ymd("2021-01-01"), ymd_hms("2021-01-01T09:00:00")
)

create_single_dose_dataset(data,
  lookup_table = custom_lookup,
  lookup_column = Value,
  start_datetime = ASTDTM,
  end_datetime = AENDTM
)
# Example with nominal time

data &lt;- tribble(
  ~USUBJID, ~EXDOSFRQ, ~NFRLT, ~ASTDT, ~ASTDTM, ~AENDT, ~AENDTM,
  "P01", "BID", 0, ymd("2021-01-01"), ymd_hms("2021-01-01 08:00:00"),
  ymd("2021-01-07"), ymd_hms("2021-01-07 20:00:00"),
  "P01", "BID", 168, ymd("2021-01-08"), ymd_hms("2021-01-08 08:00:00"),
  ymd("2021-01-14"), ymd_hms("2021-01-14 20:00:00"),
  "P01", "BID", 336, ymd("2021-01-15"), ymd_hms("2021-01-15 08:00:00"),
  ymd("2021-01-29"), ymd_hms("2021-01-29 20:00:00")
)

create_single_dose_dataset(data,
  dose_freq = EXDOSFRQ,
  start_date = ASTDT,
  start_datetime = ASTDTM,
  end_date = AENDT,
  end_datetime = AENDTM,
  lookup_table = dose_freq_lookup,
  lookup_column = CDISC_VALUE,
  nominal_time = NFRLT,
  keep_source_vars = exprs(
    USUBJID, EXDOSFRQ, ASTDT, ASTDTM, AENDT, AENDTM, NFRLT
  )
)

# Example - derive a single dose dataset with imputations

# For either single drug administration records, or multiple drug administration
# records covering a range of dates, fill-in of missing treatment end datetime
# `EXENDTC` by substitution with an acceptable alternate, for example date of
# death, date of datacut may be required. This example shows the
# maximum possible number of single dose records to be derived. The example
# requires the date of datacut `DCUTDT` to be specified correctly, or
# if not appropriate to use `DCUTDT` as missing treatment end data and missing
# treatment end datetime could set equal to treatment start date and treatment
# start datetime. ADSL variables `DTHDT` and `DCUTDT` are preferred for
# imputation use.
#
# All available trial treatments are included, allowing multiple different
# last dose variables to be created in for example `use_ad_template("ADAE")`
# if required.

adsl &lt;- tribble(
  ~STUDYID, ~USUBJID, ~DTHDT,
  "01", "1211", ymd("2013-01-14"),
  "01", "1083", ymd("2013-08-02"),
  "01", "1445", ymd("2014-11-01"),
  "01", "1015", NA,
  "01", "1023", NA
)

ex &lt;- tribble(
  ~STUDYID, ~USUBJID, ~EXSEQ, ~EXTRT, ~EXDOSE, ~EXDOSU, ~EXDOSFRQ, ~EXSTDTC, ~EXENDTC,
  "01", "1015", 1, "PLAC", 0, "mg", "QD", "2014-01-02", "2014-01-16",
  "01", "1015", 2, "PLAC", 0, "mg", "QD", "2014-06-17", "2014-06-18",
  "01", "1015", 3, "PLAC", 0, "mg", "QD", "2014-06-19", NA_character_,
  "01", "1023", 1, "PLAC", 0, "mg", "QD", "2012-08-05", "2012-08-27",
  "01", "1023", 2, "PLAC", 0, "mg", "QD", "2012-08-28", "2012-09-01",
  "01", "1211", 1, "XANO", 54, "mg", "QD", "2012-11-15", "2012-11-28",
  "01", "1211", 2, "XANO", 54, "mg", "QD", "2012-11-29", NA_character_,
  "01", "1445", 1, "PLAC", 0, "mg", "QD", "2014-05-11", "2014-05-25",
  "01", "1445", 2, "PLAC", 0, "mg", "QD", "2014-05-26", "2014-11-01",
  "01", "1083", 1, "PLAC", 0, "mg", "QD", "2013-07-22", "2013-08-01"
)

adsl_death &lt;- adsl %&gt;%
  mutate(
    DTHDTM = convert_date_to_dtm(DTHDT),
    # Remove `DCUT` setup line below if ADSL `DCUTDT` is populated.
    DCUTDT = convert_dtc_to_dt("2015-03-06"), # Example only, enter date.
    DCUTDTM = convert_date_to_dtm(DCUTDT)
  )

# Select valid dose records, non-missing `EXSTDTC` and `EXDOSE`.
ex_mod &lt;- ex %&gt;%
  filter(!is.na(EXSTDTC) &amp; !is.na(EXDOSE)) %&gt;%
  derive_vars_merged(adsl_death, by_vars = exprs(STUDYID, USUBJID)) %&gt;%
  # Example, set up missing `EXDOSFRQ` as QD daily dosing regime.
  # Replace with study dosing regime per trial treatment.
  mutate(EXDOSFRQ = if_else(is.na(EXDOSFRQ), "QD", EXDOSFRQ)) %&gt;%
  # Create EXxxDTM variables and replace missing `EXENDTM`.
  derive_vars_dtm(
    dtc = EXSTDTC,
    new_vars_prefix = "EXST",
    date_imputation = "first",
    time_imputation = "first",
    flag_imputation = "none",
  ) %&gt;%
  derive_vars_dtm_to_dt(exprs(EXSTDTM)) %&gt;%
  derive_vars_dtm(
    dtc = EXENDTC,
    new_vars_prefix = "EXEN",
    # Maximum imputed treatment end date must not be not greater than
    # date of death or after the datacut date.
    max_dates = exprs(DTHDTM, DCUTDTM),
    date_imputation = "last",
    time_imputation = "last",
    flag_imputation = "none",
    highest_imputation = "Y",
  ) %&gt;%
  derive_vars_dtm_to_dt(exprs(EXENDTM)) %&gt;%
  # Select only unique values.
  # Removes duplicated records before final step.
  distinct(
    STUDYID, USUBJID, EXTRT, EXDOSE, EXDOSFRQ, DCUTDT, DTHDT, EXSTDT,
    EXSTDTM, EXENDT, EXENDTM, EXSTDTC, EXENDTC
  )

create_single_dose_dataset(
  ex_mod,
  start_date = EXSTDT,
  start_datetime = EXSTDTM,
  end_date = EXENDT,
  end_datetime = EXENDTM,
  keep_source_vars = exprs(
    STUDYID, USUBJID, EXTRT, EXDOSE, EXDOSFRQ,
    DCUTDT, EXSTDT, EXSTDTM, EXENDT, EXENDTM, EXSTDTC, EXENDTC
  )
)
</code></pre>


</div>