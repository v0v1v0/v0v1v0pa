<div class="container">

<table style="width: 100%;"><tr>
<td>auto_MrP</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Improve MrP through ensemble learning.</h2>

<h3>Description</h3>

<p>This package improves the prediction performance of multilevel
regression with post-stratification (MrP) by combining a number of machine
learning methods through ensemble Bayesian model averaging (EBMA).
</p>


<h3>Usage</h3>

<pre><code class="language-R">auto_MrP(
  y,
  L1.x,
  L2.x,
  L2.unit,
  L2.reg = NULL,
  L2.x.scale = TRUE,
  pcs = NULL,
  folds = NULL,
  bin.proportion = NULL,
  bin.size = NULL,
  survey,
  census,
  ebma.size = 1/3,
  cores = 1,
  k.folds = 5,
  cv.sampling = "L2 units",
  loss.unit = c("individuals", "L2 units"),
  loss.fun = c("msfe", "cross-entropy", "f1", "MSE"),
  best.subset = TRUE,
  lasso = TRUE,
  pca = TRUE,
  gb = TRUE,
  svm = TRUE,
  mrp = FALSE,
  deep.mrp = FALSE,
  oversampling = FALSE,
  best.subset.L2.x = NULL,
  lasso.L2.x = NULL,
  pca.L2.x = NULL,
  gb.L2.x = NULL,
  svm.L2.x = NULL,
  mrp.L2.x = NULL,
  gb.L2.unit = TRUE,
  gb.L2.reg = FALSE,
  svm.L2.unit = TRUE,
  svm.L2.reg = FALSE,
  deep.L2.x = NULL,
  deep.L2.reg = TRUE,
  deep.splines = TRUE,
  lasso.lambda = NULL,
  lasso.n.iter = 100,
  gb.interaction.depth = c(1, 2, 3),
  gb.shrinkage = c(0.04, 0.01, 0.008, 0.005, 0.001),
  gb.n.trees.init = 50,
  gb.n.trees.increase = 50,
  gb.n.trees.max = 1000,
  gb.n.minobsinnode = 20,
  svm.kernel = c("radial"),
  svm.gamma = NULL,
  svm.cost = NULL,
  ebma.n.draws = 100,
  ebma.tol = c(0.01, 0.005, 0.001, 5e-04, 1e-04, 5e-05, 1e-05),
  verbose = FALSE,
  uncertainty = FALSE,
  boot.iter = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>
<p>Outcome variable. A character vector containing the column names of
the outcome variable. A character scalar containing the column name of
the outcome variable in <code>survey</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>L1.x</code></td>
<td>
<p>Individual-level covariates. A character vector containing the
column names of the individual-level variables in <code>survey</code> and
<code>census</code> used to predict outcome <code>y</code>. Note that geographic unit
is specified in argument <code>L2.unit</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>L2.x</code></td>
<td>
<p>Context-level covariates. A character vector containing the
column names of the context-level variables in <code>survey</code> and
<code>census</code> used to predict outcome <code>y</code>. To exclude context-level
variables, set <code>L2.x = NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>L2.unit</code></td>
<td>
<p>Geographic unit. A character scalar containing the column
name of the geographic unit in <code>survey</code> and <code>census</code> at which
outcomes should be aggregated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>L2.reg</code></td>
<td>
<p>Geographic region. A character scalar containing the column
name of the geographic region in <code>survey</code> and <code>census</code> by which
geographic units are grouped (<code>L2.unit</code> must be nested within
<code>L2.reg</code>). Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>L2.x.scale</code></td>
<td>
<p>Scale context-level covariates. A logical argument
indicating whether the context-level covariates should be normalized.
Default is <code>TRUE</code>. Note that if set to <code>FALSE</code>, then the
context-level covariates should be normalized prior to calling
<code>auto_MrP()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pcs</code></td>
<td>
<p>Principal components. A character vector containing the column
names of the principal components of the context-level variables in
<code>survey</code> and <code>census</code>. Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>folds</code></td>
<td>
<p>EBMA and cross-validation folds. A character scalar containing
the column name of the variable in <code>survey</code> that specifies the fold
to which an observation is allocated. The variable should contain integers
running from <code class="reqn">1</code> to <code class="reqn">k + 1</code>, where <code class="reqn">k</code> is the number of
cross-validation folds. Value <code class="reqn">k + 1</code> refers to the EBMA fold. Default
is <code>NULL</code>. <em>Note:</em> if <code>folds</code> is <code>NULL</code>, then
<code>ebma.size</code>, <code>k.folds</code>, and <code>cv.sampling</code> must be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bin.proportion</code></td>
<td>
<p>Proportion of ideal types. A character scalar
containing the column name of the variable in <code>census</code> that indicates
the proportion of individuals by ideal type and geographic unit. Default is
<code>NULL</code>. <em>Note:</em> if <code>bin.proportion</code> is <code>NULL</code>, then
<code>bin.size</code> must be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bin.size</code></td>
<td>
<p>Bin size of ideal types. A character scalar containing the
column name of the variable in <code>census</code> that indicates the bin size of
ideal types by geographic unit. Default is <code>NULL</code>. <em>Note:</em>
ignored if <code>bin.proportion</code> is provided, but must be specified
otherwise.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>survey</code></td>
<td>
<p>Survey data. A <code>data.frame</code> whose column names include
<code>y</code>, <code>L1.x</code>, <code>L2.x</code>, <code>L2.unit</code>, and, if specified,
<code>L2.reg</code>, <code>pcs</code>, and <code>folds</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>census</code></td>
<td>
<p>Census data. A <code>data.frame</code> whose column names include
<code>L1.x</code>, <code>L2.x</code>, <code>L2.unit</code>, if specified, <code>L2.reg</code> and
<code>pcs</code>, and either <code>bin.proportion</code> or <code>bin.size</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ebma.size</code></td>
<td>
<p>EBMA fold size. A number in the open unit interval
indicating the proportion of respondents to be allocated to the EBMA fold.
Default is <code class="reqn">1/3</code>. <em>Note:</em> ignored if <code>folds</code> is provided, but
must be specified otherwise.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cores</code></td>
<td>
<p>The number of cores to be used. An integer indicating the number
of processor cores used for parallel computing. Default is 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k.folds</code></td>
<td>
<p>Number of cross-validation folds. An integer-valued scalar
indicating the number of folds to be used in cross-validation. Default is
<code class="reqn">5</code>. <em>Note:</em> ignored if <code>folds</code> is provided, but must be
specified otherwise.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cv.sampling</code></td>
<td>
<p>Cross-validation sampling method. A character-valued
scalar indicating whether cross-validation folds should be created by
sampling individual respondents (<code>individuals</code>) or geographic units
(<code>L2 units</code>). Default is <code>L2 units</code>. <em>Note:</em> ignored if
<code>folds</code> is provided, but must be specified otherwise.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loss.unit</code></td>
<td>
<p>Loss function unit. A character-valued scalar indicating
whether performance loss should be evaluated at the level of individual
respondents (<code>individuals</code>), geographic units (<code>L2 units</code>) or at
both levels. Default is <code>c("individuals", "L2 units")</code>. With multiple
loss units, parameters are ranked for each loss unit and the loss unit with
the lowest rank sum is chosen. Ties are broken according to the order in
the search grid.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loss.fun</code></td>
<td>
<p>Loss function. A character-valued scalar indicating whether
prediction loss should be measured by the mean squared error (<code>MSE</code>),
the mean absolute error (<code>MAE</code>), binary cross-entropy
(<code>cross-entropy</code>), mean squared false error (<code>msfe</code>), the f1
score (<code>f1</code>), or a combination thereof. Default is <code>c("MSE",
"cross-entropy","msfe", "f1")</code>. With multiple loss functions, parameters
are ranked for each loss function and the parameter combination with the
lowest rank sum is chosen. Ties are broken according to the order in the
search grid.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>best.subset</code></td>
<td>
<p>Best subset classifier. A logical argument indicating
whether the best subset classifier should be used for predicting outcome
<code>y</code>. Default is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lasso</code></td>
<td>
<p>Lasso classifier. A logical argument indicating whether the
lasso classifier should be used for predicting outcome <code>y</code>. Default is
<code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pca</code></td>
<td>
<p>PCA classifier. A logical argument indicating whether the PCA
classifier should be used for predicting outcome <code>y</code>. Default is
<code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb</code></td>
<td>
<p>GB classifier. A logical argument indicating whether the GB
classifier should be used for predicting outcome <code>y</code>. Default is
<code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm</code></td>
<td>
<p>SVM classifier. A logical argument indicating whether the SVM
classifier should be used for predicting outcome <code>y</code>. Default is
<code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mrp</code></td>
<td>
<p>MRP classifier. A logical argument indicating whether the standard
MRP classifier should be used for predicting outcome <code>y</code>. Default is
<code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>deep.mrp</code></td>
<td>
<p>Deep MRP classifier. A logical argument indicating whether
the deep MRP classifier should be used for predicting outcome <code>y</code>.
Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>oversampling</code></td>
<td>
<p>Over sample to create balance on the dependent variable.
A logical argument. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>best.subset.L2.x</code></td>
<td>
<p>Best subset context-level covariates. A character
vector containing the column names of the context-level variables in
<code>survey</code> and <code>census</code> to be used by the best subset classifier.
If <code>NULL</code> and <code>best.subset</code> is set to <code>TRUE</code>, then best
subset uses the variables specified in <code>L2.x</code>. Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lasso.L2.x</code></td>
<td>
<p>Lasso context-level covariates. A character vector
containing the column names of the context-level variables in
<code>survey</code> and <code>census</code> to be used by the lasso classifier. If
<code>NULL</code> and <code>lasso</code> is set to <code>TRUE</code>, then lasso uses the
variables specified in <code>L2.x</code>. Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pca.L2.x</code></td>
<td>
<p>PCA context-level covariates. A character vector containing
the column names of the context-level variables in <code>survey</code> and
<code>census</code> whose principal components are to be used by the PCA
classifier. If <code>NULL</code> and <code>pca</code> is set to <code>TRUE</code>, then PCA
uses the principal components of the variables specified in <code>L2.x</code>.
Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.L2.x</code></td>
<td>
<p>GB context-level covariates. A character vector containing the
column names of the context-level variables in <code>survey</code> and
<code>census</code> to be used by the GB classifier. If <code>NULL</code> and <code>gb</code>
is set to <code>TRUE</code>, then GB uses the variables specified in <code>L2.x</code>.
Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm.L2.x</code></td>
<td>
<p>SVM context-level covariates. A character vector containing
the column names of the context-level variables in <code>survey</code> and
<code>census</code> to be used by the SVM classifier. If <code>NULL</code> and
<code>svm</code> is set to <code>TRUE</code>, then SVM uses the variables specified in
<code>L2.x</code>. Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mrp.L2.x</code></td>
<td>
<p>MRP context-level covariates. A character vector containing
the column names of the context-level variables in <code>survey</code> and
<code>census</code> to be used by the MRP classifier. The character vector
<em>empty</em> if no context-level variables should be used by the MRP
classifier. If <code>NULL</code> and <code>mrp</code> is set to <code>TRUE</code>, then MRP
uses the variables specified in <code>L2.x</code>. Default is <code>NULL</code>. Note:
For the empty MrP model, set <code>L2.x = NULL</code> and <code>mrp.L2.x = ""</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.L2.unit</code></td>
<td>
<p>GB L2.unit. A logical argument indicating whether
<code>L2.unit</code> should be included in the GB classifier. Default is
<code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.L2.reg</code></td>
<td>
<p>GB L2.reg. A logical argument indicating whether
<code>L2.reg</code> should be included in the GB classifier. Default is
<code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm.L2.unit</code></td>
<td>
<p>SVM L2.unit. A logical argument indicating whether
<code>L2.unit</code> should be included in the SVM classifier. Default is
<code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm.L2.reg</code></td>
<td>
<p>SVM L2.reg. A logical argument indicating whether
<code>L2.reg</code> should be included in the SVM classifier. Default is
<code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>deep.L2.x</code></td>
<td>
<p>Deep MRP context-level covariates. A character vector
containing the column names of the context-level variables in <code>survey</code>
and <code>census</code> to be used by the deep MRP classifier. If <code>NULL</code> and
<code>deep.mrp</code> is set to <code>TRUE</code>, then deep MRP uses the variables
specified in <code>L2.x</code>. Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>deep.L2.reg</code></td>
<td>
<p>Deep MRP L2.reg. A logical argument indicating whether
<code>L2.reg</code> should be included in the deep MRP classifier. Default is
<code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>deep.splines</code></td>
<td>
<p>Deep MRP splines. A logical argument indicating whether
splines should be used in the deep MRP classifier. Default is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lasso.lambda</code></td>
<td>
<p>Lasso penalty parameter. A numeric <code>vector</code> of
non-negative values. The penalty parameter controls the shrinkage of the
context-level variables in the lasso model. Default is a sequence with
minimum 0.1 and maximum 250 that is equally spaced on the log-scale. The
number of values is controlled by the <code>lasso.n.iter</code> parameter.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lasso.n.iter</code></td>
<td>
<p>Lasso number of lambda values. An integer-valued scalar
specifying the number of lambda values to search over. Default is
<code class="reqn">100</code>. <em>Note:</em> Is ignored if a vector of <code>lasso.lambda</code>
values is provided.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.interaction.depth</code></td>
<td>
<p>GB interaction depth. An integer-valued vector
whose values specify the interaction depth of GB. The interaction depth
defines the maximum depth of each tree grown (i.e., the maximum level of
variable interactions). Default is <code>c(1, 2, 3)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.shrinkage</code></td>
<td>
<p>GB learning rate. A numeric vector whose values specify
the learning rate or step-size reduction of GB. Values between <code class="reqn">0.001</code>
and <code class="reqn">0.1</code> usually work, but a smaller learning rate typically requires
more trees. Default is <code>c(0.04, 0.01, 0.008, 0.005, 0.001)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.n.trees.init</code></td>
<td>
<p>GB initial total number of trees. An integer-valued
scalar specifying the initial number of total trees to fit by GB. Default
is <code class="reqn">50</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.n.trees.increase</code></td>
<td>
<p>GB increase in total number of trees. An
integer-valued scalar specifying by how many trees the total number of
trees to fit should be increased (until <code>gb.n.trees.max</code> is reached).
Default is <code class="reqn">50</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.n.trees.max</code></td>
<td>
<p>GB maximum number of trees. An integer-valued scalar
specifying the maximum number of trees to fit by GB. Default is <code class="reqn">1000</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>gb.n.minobsinnode</code></td>
<td>
<p>GB minimum number of observations in the terminal
nodes. An integer-valued scalar specifying the minimum number of
observations that each terminal node of the trees must contain. Default is
<code class="reqn">20</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm.kernel</code></td>
<td>
<p>SVM kernel. A character-valued scalar specifying the kernel
to be used by SVM. The possible values are <code>linear</code>,
<code>polynomial</code>, <code>radial</code>, and <code>sigmoid</code>. Default is
<code>radial</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm.gamma</code></td>
<td>
<p>SVM kernel parameter. A numeric vector whose values specify
the gamma parameter in the SVM kernel. This parameter is needed for all
kernel types except linear. Default is a sequence with minimum = 1e-5,
maximum = 1e-1, and length = 20 that is equally spaced on the log-scale.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>svm.cost</code></td>
<td>
<p>SVM cost parameter. A numeric vector whose values specify the
cost of constraints violation in SVM. Default is a sequence with minimum =
0.5, maximum = 10, and length = 5 that is equally spaced on the log-scale.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ebma.n.draws</code></td>
<td>
<p>EBMA number of samples. An integer-valued scalar
specifying the number of bootstrapped samples to be drawn from the EBMA
fold and used for tuning EBMA. Default is <code class="reqn">100</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ebma.tol</code></td>
<td>
<p>EBMA tolerance. A numeric vector containing the
tolerance values for improvements in the log-likelihood before the EM
algorithm stops optimization. Values should range at least from <code class="reqn">0.01</code>
to <code class="reqn">0.001</code>. Default is
<code>c(0.01, 0.005, 0.001, 0.0005, 0.0001, 0.00005, 0.00001)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Verbose output. A logical argument indicating whether or not
verbose output should be printed. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>uncertainty</code></td>
<td>
<p>Uncertainty estimates. A logical argument indicating
whether uncertainty estimates should be computed. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>boot.iter</code></td>
<td>
<p>Number of bootstrap iterations. An integer argument
indicating the number of bootstrap iterations to be computed. Will be
ignored unless <code>uncertainty = TRUE</code>. Default is <code>200</code> if
<code>uncertainty = TRUE</code> and <code>NULL</code> if <code>uncertainty = FALSE</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Bootstrapping samples the level two units, sometimes referred to as
the cluster bootstrap. For the multilevel model, for example, when running
MrP only, the bootstrapped median level two predictions will differ from
the level two predictions without bootstrapping. We recommend assessing the
difference by running autoMrP without bootstrapping alongside autoMrP with
bootstrapping and then comparing level two predictions from the model
without bootstrapping to the median level two predictions from the model
with bootstrapping.
</p>
<p>To ensure reproducability of the results, use the <code>set.seed()</code>
function to specify a seed.
</p>


<h3>Value</h3>

<p>The context-level predictions. A list with two elements. The first
element, <code>EBMA</code>, contains the post-stratified ensemble bayesian model
avaeraging (EBMA) predictions. The second element, <code>classifiers</code>,
contains the post-stratified predictions from all estimated classifiers.
</p>


<h3>Examples</h3>

<pre><code class="language-R"># An MrP model without machine learning
set.seed(123)
m &lt;- auto_MrP(
  y = "YES",
  L1.x = c("L1x1"),
  L2.x = c("L2.x1", "L2.x2"),
  L2.unit = "state",
  bin.proportion = "proportion",
  survey = taxes_survey,
  census = taxes_census,
  ebma.size = 0,
  cores = 2,
  best.subset = FALSE,
  lasso = FALSE,
  pca = FALSE,
  gb = FALSE,
  svm = FALSE,
  mrp = TRUE
)

# summarize and plot results
summary(m)
plot(m)

# An MrP model without context-level predictors
m &lt;- auto_MrP(
  y = "YES",
  L1.x = "L1x1",
  L2.x = NULL,
  mrp.L2.x = "",
  L2.unit = "state",
  bin.proportion = "proportion",
  survey = taxes_survey,
  census = taxes_census,
  ebma.size = 0,
  cores = 1,
  best.subset = FALSE,
  lasso = FALSE,
  pca = FALSE,
  gb = FALSE,
  svm = FALSE,
  mrp = TRUE
  )


# Predictions with machine learning

# detect number of available cores
max_cores &lt;- parallel::detectCores()

# autoMrP with machine learning
ml_out &lt;- auto_MrP(
  y = "YES",
  L1.x = c("L1x1", "L1x2", "L1x3"),
  L2.x = c("L2.x1", "L2.x2", "L2.x3", "L2.x4", "L2.x5", "L2.x6"),
  L2.unit = "state",
  L2.reg = "region",
  bin.proportion = "proportion",
  survey = taxes_survey,
  census = taxes_census,
  gb.L2.reg = TRUE,
  svm.L2.reg = TRUE,
  cores = min(2, max_cores)
  )

</code></pre>


</div>