<div class="container">

<table style="width: 100%;"><tr>
<td>– Introduction –</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Introduction</h2>

<h3>Description</h3>

<p>Essential information, tips and tricks
</p>


<h3>Details</h3>

<p>Welcoming JavaScript library AMap into the world of R.
AMap is an advanced mapping library made in China and widely used there.
It features 2D/3D animation, supports a multitude of layers and markers,
data import, flyover playback, etc. <br> Library <em>amapro</em> let you
control AMap from R and Shiny. It uses AMap’s native commands/parameters
wrapped in just a few commands.
</p>


<h3>Translation</h3>

<p>AMap’s documentation is in Chinese and most links here make reference to
it. If you happen <em>not</em> to know Chinese, it is convenient to set your
browser to
<a href="https://www.howtogeek.com/407924/how-to-turn-translation-on-or-off-in-chrome/">auto-translate</a>.
This will help a little or a lot depending on the website/page
structure. One can also copy/paste text to <a href="https://translate.google.com?sl=auto&amp;tl=en">Google translate</a>.
</p>


<h3>Installation</h3>

<p>Install <strong>amapro</strong> from Github with
<code>remotes::install_github("helgasoft/amapro")</code>
CRAN version also available but usually outdated.
</p>
<p>Run with the following commands <br><code style="white-space: pre;">⁠library(amapro); am.init()⁠</code> <br> A
pop-up dialog will ask for an <strong>API key</strong> (shows once, will not be
repeated). <br> API key is obtained through
<a href="https://console.amap.com/dev/id/phone">registration</a>, expecting you to
provide a Chinese phone number for SMS verification. <br> How to get an
API key if you reside out of China?
</p>

<ul>
<li>
<p> ask a friend from China to help, or hire a local
<a href="https://www.truelancer.com/freelancers-in-china">freelancer</a>
</p>
</li>
<li>
<p> search the web for a shared key
</p>
</li>
<li>
<p> use a temporary Chinese phone number from sites like <em>sms24.me</em>,
<em>turtle-sms.xyz</em>, etc. However most are probably blacklisted as the
registration page shows them as <em>‘already registered’</em>.
</p>
</li>
<li>
<p> select temporarily the ‘demo’ option, without guarantee to work in the
long run
</p>
</li>
</ul>
<h3>Shiny Demo</h3>

<p>Interactive, hands-on showcase of many library features. Activate with
the following command: <br><code style="white-space: pre;">⁠library(amapro); demo(am.shiny)⁠</code>
</p>


<h3>API links</h3>

<p><em>amapro</em> is based on version 2.0 of AMap (JSAPI v2.0). “API”
auto-translates as “Reference book” in web menus.
</p>


<h4>AMap</h4>

<p>The base library with optional plugins. Most important links are
</p>

<ul>
<li> <p><a href="https://lbs.amap.com/api/jsapi-v2/summary/">Summary</a>
</p>
</li>
<li> <p><a href="https://lbs.amap.com/api/jsapi-v2/guide/abc/quickstart">Guide</a>
</p>
</li>
<li> <p><a href="https://a.amap.com/jsapi/static/doc/index.html">API</a> documentation,
good auto-translation
</p>
</li>
<li> <p><a href="https://lbs.amap.com/demo/list/jsapi-v2">Examples</a> - live demos
</p>
</li>
</ul>
<h4>LOCA</h4>

<p>AMap extension with enhanced 3D features. In <em>amapro</em> it is invoked with
a parameter - <code>am.init(loca=TRUE, ...)</code>. The documentation
auto-translates well in the browser.
</p>

<ul>
<li> <p><a href="https://lbs.amap.com/api/loca-v2/intro">Intro</a>
</p>
</li>
<li> <p><a href="https://a.amap.com/Loca/static/loca-v2/doc/html/index.html">API</a>
documentation
</p>
</li>
</ul>
<h3>Commands</h3>

<p>Controlling map and elements is done by sending AMap commands to them.
Commands can be chained with the pipe operator |&gt; or %&gt;% and are
executed sequentially in the order received. <br> Example:
<code>am.cmd('setAngle', 'carIcon', -90)</code> <br><em>amapro</em> uses native AMap
commands and introduces these <ins>additional</ins>:
</p>

<ul>
<li> <p><strong>set</strong> - create new element
</p>

<ul>
<li>
<p> with <em>name</em>: add new global JS object outside the map <br><code>am.cmd('set', 'VectorLayer', name='e$layer1')</code>
</p>
</li>
<li>
<p> without <em>name</em>: add new element to map <br><code>am.cmd('set', 'e$marker1', position= c(116.478, 39.998))</code>
</p>
</li>
</ul>
</li>
<li> <p><strong>addTo</strong> - append one existing JS object to another by name <br><code>am.cmd('addTo', 'e$layer1', 'e$marker1')</code>
</p>
</li>
<li> <p><strong>var</strong> - set a JavaScript variable <br><code>am.cmd('var', 'e$myOpacity', 0.8)</code>
</p>
</li>
<li> <p><strong>code</strong> - execute JavaScript code <br><code>am.cmd('code', 'alert("I am JS");')</code>
</p>
</li>
</ul>
<p>AMap commands starting with <strong>get</strong> return data from the map or related
objects. <br> Put the data in a Shiny input variable by setting its name
in parameter <strong>r</strong>. <br> Example:
<code>am.cmd('getCenter', 'map', r='inShiny1')</code> <br> Above command will
update <em>input$inShiny1</em> with the Lng/Lat coordinates of the map center.
</p>


<h3>Events</h3>

<p>Events could be defined for map and elements. All types of instances use
<strong>on/off methods</strong> to bind and remove events. <br> Events are set in
attribute <strong>on</strong>(or <strong>off</strong>) as a list of lists. Each event is a
separate list with event name in <strong>e</strong>, a JS function <strong>f</strong> and
optionally a query <strong>q</strong>.
Example:
</p>
<div class="sourceCode r"><pre>am.init(center= c(116.475, 39.997), zoom= 17,
        on= list(list(e= 'complete', 
                      f= "function() {alert('loaded!');}")) )
</pre></div>
<p>on/off events without <em>name</em> are ignored, except for the map itself (as
above example). <br> JavaScript function <em>Shiny.setInputValue()</em> can be
used to send data back to Shiny.
</p>


<h3>Limitations</h3>


<ul>
<li>
<p> only one map is created by <em>am.init</em> per session. It is a JS global
called ‘m$jmap’.
</p>
</li>
<li>
<p> AMap command
<a href="https://a.amap.com/jsapi/static/doc/index.html#controladdto">addTo</a>
is overwritten by <em>amapro</em> and cannot be used.
</p>
</li>
<li>
<p> the <strong>supported AMap plugins</strong> are: ControlBar, Scale, ToolBar,
MoveAnimation, MouseTool, HeatMap, GeoJSON, ElasticMarker.
</p>
</li>
<li>
<p> most <strong>built-in</strong> AMap tile layers (Satellite, Traffic, Roads) are
limited to China only. However, with command <em>am.item(‘TileLayer’)</em>,
one can use any <a href="https://leaflet-extras.github.io/leaflet-providers/preview/">Leaflet provider</a>
for worldwide coverage.
</p>
</li>
<li>
<p> AMap built-in <a href="https://lbs.amap.com/api/jsapi-v2/guide/layers/official-layers">map layers</a>
are <a href="https://en.wikipedia.org/wiki/Restrictions_on_geographic_data_in_China">GCJ-02 coded</a>
and coordinates collected on them will display incorrectly in Leaflet
or other WGS-84 based maps, and vice-versa. They need to be
<a href="https://lbs.amap.com/api/jsapi-v2/guide/transform/convertfrom">converted</a>.
Conversion is available through function
<a href="https://lbs.amap.com/api/jsapi-v2/documentation#convertfrom">convertFrom</a>.
</p>
</li>
<li>
<p> AMap ecosystem is vast, <strong>unsupported features</strong> include:
‘BesizerCurve’, ‘MarkerCluster’, ‘HawkEye’,
<a href="https://lbs.amap.com/demo/javascript-api/example/indoormap/indoormap/">IndoorMap</a>,
<a href="https://lbs.amap.com/demo/javascript-api/example/selflayer/cus-svg">CustomLayer</a>,
‘GLCustomLayer’, ‘DistrictLayer’, ‘LayerGroup’, all editors like
‘PolygonEditor’,‘Webservice’, ‘Search(AMap.Autocomplete,
AMap.PlaceSearch)’, ‘Geocoding(AMap.Geocoder)’, Route planning, other
services(weather, districts, etc.), positioning, utilities.
</p>
</li>
<li>
<p> most <strong>Loca</strong> elements are supported, but not all have been tested.
Latest <em>AmbientLight</em>, <em>DirectionalLight</em> and <em>PointLight</em> objects are
not supported, but parameters <em>ambLight</em>, <em>dirLight</em> and <em>pointLight</em>
accomplish the same. Loca events are not supported yet.
</p>
</li>
<li> <p><em>loca.js</em> file has several versions, the latest (bigger) one does not
work well with the current <em>amap.js</em>
</p>
</li>
</ul>
<h3>Tips</h3>


<ul>
<li>
<p> all named objects created in JS are <a href="https://developer.mozilla.org/en-US/docs/Glossary/Global_object">global variables</a>
(<em>window.name</em>). Good practice is to use a name prefix (m$) to avoid
overwriting accidentally external variables.
</p>
</li>
<li>
<p> API attributes could be set to a JS function instead of a value.
Function is defined as a string starting with word “function”.
</p>
</li>
<li>
<p> usually WMS/WMTS tiles come from external servers and may present a
CORS problem - browser refusal to load. One can install a small
<a href="https://chrome.google.com/webstore/detail/allow-cors-access-control/lhobafahddgcelffkeicbaginigeejlf">extension in Chrome</a>
or
<a href="https://addons.mozilla.org/en-US/firefox/addon/access-control-allow-origin/">Firefox</a>
to fix this problem manually inside the browser.
</p>
</li>
<li>
<p> AMap has several predefined <a href="https://lbs.amap.com/api/jsapi-v2/guide/map/map-style/">Map styles</a>. Could
be set in map options with <em>mapStyle</em>.
</p>
</li>
<li> <p><em>amapro</em> silent errors are collected in the browser Console. Press key
<strong>F12</strong> to open the dev.environment, then open tab “Console” to view
them.
</p>
</li>
<li>
<p> Chrome/Firefox extensions may interfere with map presentation (like
‘uBlock’)
</p>
</li>
</ul>
</div>